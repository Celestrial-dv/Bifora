# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# COSING (EU CosIng) í™”ìž¥í’ˆ ì„±ë¶„ ìžë™ ë™ê¸°í™” Workflow v1.5
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# íŒŒì¼: /biplex/cosing_sync.yml
#
# ðŸ“… ìƒì„±ì¼: 2025-10-21
# ðŸ”„ ìµœì¢… ìˆ˜ì •: v1.5 (2025-10-22)
#
# âœ… v1.5 Updates (2025-10-22):
# - [ê°œì„ ] ê³ ì • ì‹œê°„ ëŒ€ê¸°(sleep) ë°©ì‹ì„ ìƒíƒœ í™•ì¸(Polling) ë°©ì‹ìœ¼ë¡œ ë³€ê²½
#   - ìž‘ì—… ì™„ë£Œ ì‹œ ì¦‰ì‹œ ë‹¤ìŒ ë‹¨ê³„ë¡œ ì§„í–‰í•˜ì—¬ ì›Œí¬í”Œë¡œìš° ì‹œê°„ ë‹¨ì¶•
#   - ì„œë²„ì˜ ì‹¤ì œ ìž‘ì—… ìƒíƒœë¥¼ ì£¼ê¸°ì ìœ¼ë¡œ í™•ì¸í•˜ì—¬ ì•ˆì •ì„± í–¥ìƒ
# - [ì¶”ê°€] Webhook í˜¸ì¶œ ì‹œ log_idë¥¼ ì¶”ì¶œí•˜ì—¬ ìƒíƒœ í™•ì¸ì— ì‚¬ìš©
#
# âœ… v1.4 Updates (2025-10-22):
# - [ìˆ˜ì •] Webhook í˜¸ì¶œ ë°©ì‹ì„ POSTì—ì„œ GETìœ¼ë¡œ ë³€ê²½ (WAF ì°¨ë‹¨ ìš°íšŒ)
# - [ê·¼ê±°] ì •ìƒ ë™ìž‘í•˜ëŠ” rag_sync.yml ì›Œí¬í”Œë¡œìš°ì™€ì˜ ë¹„êµ ë¶„ì„
#
# âœ… v1.3 Updates (2025-10-22):
# - Webhook í˜¸ì¶œ ì‹œ ë¶ˆí•„ìš”í•œ JSON í—¤ë” ì œê±° (WAF ì°¨ë‹¨ ìš°íšŒ)
# - ì•ˆì •ì ì¸ ìš”ì²­ì„ ìœ„í•´ User-Agent í—¤ë” ì¶”ê°€
# - ì‹ ê·œ Secret ì‚¬ìš©: DATA_SYNC_WEBHOOK_URL (MFDS/COSING ì „ìš©)
#
# âœ… v1.2 Updates (2025-10-22): Secret ë³€ê²½
# - ì‹ ê·œ Secret ì‚¬ìš©: DATA_SYNC_WEBHOOK_URL (MFDS/COSING ì „ìš©)
# - ê¸°ì¡´ CAFE24_SYNC_URLê³¼ ë¶„ë¦¬ (Supabase ì „ìš©)
# 
# âœ… v1.1 Updates (2025-10-22): ì‹¤í–‰ ì‹œê°„ ë³€ê²½ ë° ë™ì‹œ ì‹¤í–‰ ì§€ì›
# - ì‹¤í–‰ ì‹œê°„: ë§¤ì£¼ ì¼ìš”ì¼ 03:00 KST â†’ ë§¤ì¼ 22:00 KST
# - MFDSì™€ ë™ì‹œ ì‹¤í–‰ ê°€ëŠ¥ (ë¹„ë™ê¸° ì²˜ë¦¬)
#
# ðŸ“‹ ê¸°ëŠ¥:
#   - EU CosIng CSV íŒŒì¼ ìžë™ ë‹¤ìš´ë¡œë“œ ë° íŒŒì‹±
#   - ë§¤ì£¼ ì¼ìš”ì¼ ìƒˆë²½ 3ì‹œ(KST) ìžë™ ì‹¤í–‰ ë˜ëŠ” ìˆ˜ë™ ì‹¤í–‰
#   - data_sync_webhook.phpë¥¼ í†µí•œ ì•ˆì „í•œ ë°ì´í„° ë™ê¸°í™”
#   - api_fetch_logs í…Œì´ë¸”ì— COSING_CSV íƒ€ìž…ìœ¼ë¡œ ë¡œê·¸ ê¸°ë¡
#
# ðŸ”— ë°ì´í„° íë¦„:
#   GitHub Actions â†’ data_sync_webhook.php (type=cosing) â†’ cosing_fetch.php â†’ MySQL
#
# ðŸŽ¯ ëŒ€ìƒ í…Œì´ë¸”:
#   - cosing_ingredients (INCIëª…, CASë²ˆí˜¸, ê¸°ëŠ¥, ì œí•œì‚¬í•­ ë“±)
#   - api_fetch_logs (ìˆ˜ì§‘ ë¡œê·¸: COSING_CSV)
#
# â° ì‹¤í–‰ ì£¼ê¸°:
#   - ë§¤ì¼ 1íšŒ (CosIng ë°ì´í„° ì—…ë°ì´íŠ¸ í™•ì¸)
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

name: COSING Data Sync (EU CosIng ì„±ë¶„) v1.5

# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# ðŸ• ì‹¤í–‰ íŠ¸ë¦¬ê±° ì„¤ì •
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
on:
  schedule:
    # ë§¤ì¼ ì˜¤í›„ 10ì‹œ(í•œêµ­ì‹œê°„) ì‹¤í–‰ (13:00 UTC)
    - cron: '0 13 * * *'
  
  workflow_dispatch:
    inputs:
      force_run:
        description: 'ê°•ì œ ì‹¤í–‰'
        required: true
        default: 'true'
        type: choice
        options:
          - 'false'
          - 'true'

env:
  DATA_SYNC_WEBHOOK_URL: ${{ secrets.DATA_SYNC_WEBHOOK_URL }}
  SYNC_TOKEN: ${{ secrets.SYNC_TOKEN }}

jobs:
  preflight:
    name: ðŸ” ì‚¬ì „ ì§„ë‹¨
    runs-on: ubuntu-latest
    outputs:
      can_proceed: ${{ steps.check.outputs.can_proceed }}
      
    steps:
      - name: âš™ï¸ í™˜ê²½ ë³€ìˆ˜ í™•ì¸
        id: check
        run: |
          echo "ðŸ” í™˜ê²½ ë³€ìˆ˜ ê²€ì¦ ì¤‘..."
          if [ -z "${{ env.DATA_SYNC_WEBHOOK_URL }}" ]; then
            echo "âŒ DATA_SYNC_WEBHOOK_URLì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
            echo "can_proceed=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          if [ -z "${{ env.SYNC_TOKEN }}" ]; then
            echo "âŒ SYNC_TOKENì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
            echo "can_proceed=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          echo "âœ… í™˜ê²½ ë³€ìˆ˜ ê²€ì¦ ì™„ë£Œ"
          echo "can_proceed=true" >> $GITHUB_OUTPUT
      
      - name: ðŸŒ ì„œë²„ ì—°ê²° í…ŒìŠ¤íŠ¸
        run: |
          echo "ðŸŒ ì„œë²„ ì—°ê²° í™•ì¸ ì¤‘..."
          WEBHOOK_URL="${{ env.DATA_SYNC_WEBHOOK_URL }}"
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -X HEAD "$WEBHOOK_URL" || echo "000")
          
          if [ "$HTTP_CODE" == "000" ]; then
            echo "âŒ ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
            exit 1
          elif [ "$HTTP_CODE" == "404" ]; then
            echo "âš ï¸  data_sync_webhook.php íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (HTTP 404)"
            echo "ðŸ“ ì˜ˆìƒ ê²½ë¡œ: $WEBHOOK_URL"
            exit 1
          else
            echo "âœ… ì„œë²„ ì—°ê²° ì„±ê³µ (HTTP $HTTP_CODE)"
          fi

  sync_cosing:
    name: ðŸš€ COSING ë°ì´í„° ë™ê¸°í™”
    runs-on: ubuntu-latest
    needs: preflight
    if: needs.preflight.outputs.can_proceed == 'true'
    timeout-minutes: 90
    
    steps:
      - name: ðŸŽ¬ ë™ê¸°í™” ì‹œìž‘
        id: start_sync
        run: |
          echo "ðŸŽ¬ COSING EU ì„±ë¶„ ë°ì´í„° ìˆ˜ì§‘ì„ ì‹œìž‘í•©ë‹ˆë‹¤..."
          WEBHOOK_URL="${{ env.DATA_SYNC_WEBHOOK_URL }}"
          # Webhook URLì—ì„œ ìŠ¤í¬ë¦½íŠ¸ê°€ ìžˆëŠ” ë””ë ‰í† ë¦¬ ê²½ë¡œë¥¼ ì¶”ì¶œ
          BASE_DIR=$(dirname "$WEBHOOK_URL")
          echo "BASE_DIR=${BASE_DIR}" >> $GITHUB_OUTPUT
      
      - name: ðŸ“¡ Webhook í˜¸ì¶œ (COSING ë™ê¸°í™” íŠ¸ë¦¬ê±°)
        id: trigger
        run: |
          WEBHOOK_URL="${{ env.DATA_SYNC_WEBHOOK_URL }}"
          FULL_URL="${WEBHOOK_URL}?type=cosing&source=github&token=${{ env.SYNC_TOKEN }}"
          
          echo "ðŸ“¡ Webhook í˜¸ì¶œ ì¤‘..."
          RESPONSE=$(curl -L \
            -H "User-Agent: GitHub-Actions-Cosing-Sync/1.5" \
            -w "\n%{http_code}" \
            -s \
            --max-time 300 \
            "$FULL_URL")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n 1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          echo "ðŸ“¥ ì‘ë‹µ ì½”ë“œ: $HTTP_CODE"
          echo "ðŸ“„ ì‘ë‹µ ë‚´ìš©: $BODY"
          
          if [ "$HTTP_CODE" != "200" ]; then
            echo "âŒ Webhook í˜¸ì¶œ ì‹¤íŒ¨ (HTTP $HTTP_CODE)"
            exit 1
          fi
          
          SUCCESS=$(echo "$BODY" | jq -r '.success // false')
          if [ "$SUCCESS" != "true" ]; then
            echo "âŒ ë™ê¸°í™” íŠ¸ë¦¬ê±° ì‹¤íŒ¨: $(echo "$BODY" | jq -r '.message // "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"')"
            exit 1
          fi
          
          # â­ï¸ [ì¶”ê°€] ì‘ë‹µì—ì„œ log_idë¥¼ ì¶”ì¶œí•˜ì—¬ ë‹¤ìŒ ë‹¨ê³„ì—ì„œ ì‚¬ìš©
          LOG_ID=$(echo "$BODY" | jq -r '.data.log_id // ""')
          if [ -z "$LOG_ID" ]; then
            echo "âŒ ì‘ë‹µì—ì„œ log_idë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
            exit 1
          fi
          echo "LOG_ID=${LOG_ID}" >> $GITHUB_OUTPUT
          echo "âœ… Webhook í˜¸ì¶œ ì„±ê³µ (Log ID: ${LOG_ID})"

      # â­ï¸ [ê°œì„ ] ê³ ì • ëŒ€ê¸°(sleep)ë¥¼ ìƒíƒœ í™•ì¸(polling)ìœ¼ë¡œ ë³€ê²½
      - name: â³ ë™ê¸°í™” ì™„ë£Œ ëŒ€ê¸° (í´ë§)
        run: |
          BASE_DIR="${{ steps.start_sync.outputs.BASE_DIR }}"
          LOG_ID="${{ steps.trigger.outputs.LOG_ID }}"
          # cosing_fetch.phpì— ìžˆëŠ” get_cosing_progress ì•¡ì…˜ì„ í˜¸ì¶œ
          PROGRESS_URL="${BASE_DIR}/cosing_fetch.php"
          
          echo "â³ ì„œë²„ì˜ ë°±ê·¸ë¼ìš´ë“œ ìž‘ì—… ì™„ë£Œë¥¼ ëŒ€ê¸°í•©ë‹ˆë‹¤ (Log ID: ${LOG_ID})..."
          echo "   (ìµœëŒ€ 15ë¶„, 30ì´ˆ ê°„ê²©ìœ¼ë¡œ ìƒíƒœ í™•ì¸)"

          for i in {1..30}; do # ìµœëŒ€ 30íšŒ ì‹œë„ (30 * 30ì´ˆ = 900ì´ˆ = 15ë¶„)
            # POST ìš”ì²­ìœ¼ë¡œ ì§„í–‰ ìƒíƒœ ì¡°íšŒ
            RESPONSE=$(curl -s -X POST \
              -H "Content-Type: application/x-www-form-urlencoded" \
              -d "action=get_cosing_progress" \
              "$PROGRESS_URL")
            
            STATUS=$(echo "$RESPONSE" | jq -r '.data.status // "UNKNOWN"')
            MESSAGE=$(echo "$RESPONSE" | jq -r '.data.error_message // ""' | tr -d '\n\r') # ë©”ì‹œì§€ì—ì„œ ê°œí–‰ë¬¸ìž ì œê±°
            
            echo "   [ì‹œë„ ${i}/30] í˜„ìž¬ ìƒíƒœ: ${STATUS} - ${MESSAGE}"
            
            if [ "$STATUS" == "SUCCESS" ]; then
              echo "âœ… ë™ê¸°í™” ì„±ê³µ!"
              exit 0
            elif [ "$STATUS" == "FAILED" ]; then
              echo "âŒ ë™ê¸°í™” ì‹¤íŒ¨!"
              exit 1
            fi
            
            sleep 30
          done

          echo "â° ì‹œê°„ ì´ˆê³¼: 15ë¶„ ë‚´ì— ìž‘ì—…ì´ ì™„ë£Œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
          exit 1
      
      - name: ðŸ“Š ë™ê¸°í™” ê²°ê³¼ í™•ì¸
        id: check_result
        run: |
          BASE_DIR="${{ steps.start_sync.outputs.BASE_DIR }}"
          STATS_URL="${BASE_DIR}/monitor_api.php?action=statistics"
          
          echo "ðŸ“Š ìµœì¢… í†µê³„ ì¡°íšŒ ì¤‘..."
          STATS=$(curl -s "$STATS_URL")
          
          echo "ðŸ“„ í†µê³„ ë°ì´í„°:"
          echo "$STATS" | jq '.'
          
          COSING_TOTAL=$(echo "$STATS" | jq -r '.data.cosing.total // 0')
          COSING_LAST_FETCH=$(echo "$STATS" | jq -r '.data.cosing.last_fetch.date // "ì—†ìŒ"')
          COSING_STATUS=$(echo "$STATS" | jq -r '.data.cosing.last_fetch.status // "ì•Œ ìˆ˜ ì—†ìŒ"')
          
          echo "COSING_TOTAL=${COSING_TOTAL}" >> $GITHUB_OUTPUT
          echo "COSING_LAST_FETCH=${COSING_LAST_FETCH}" >> $GITHUB_OUTPUT
          echo "COSING_STATUS=${COSING_STATUS}" >> $GITHUB_OUTPUT
          echo "âœ… ê²°ê³¼ í™•ì¸ ì™„ë£Œ"
      
      - name: ðŸ“‹ ìµœì¢… ê²°ê³¼ ìš”ì•½
        run: |
          echo "## ðŸŽ‰ COSING ë™ê¸°í™” ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
          echo "| í•­ëª© | ê°’ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| ì „ì²´ ì„±ë¶„ ìˆ˜ | ${{ steps.check_result.outputs.COSING_TOTAL }}ê°œ |" >> $GITHUB_STEP_SUMMARY
          echo "| ë§ˆì§€ë§‰ ìˆ˜ì§‘ | ${{ steps.check_result.outputs.COSING_LAST_FETCH }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ìµœì¢… ìƒíƒœ | ${{ steps.check_result.outputs.COSING_STATUS }} |" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.check_result.outputs.COSING_STATUS }}" == "SUCCESS" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… **ë™ê¸°í™” ì„±ê³µ!**" >> $GITHUB_STEP_SUMMARY
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸  **ë™ê¸°í™” ìƒíƒœ í™•ì¸ í•„ìš”**" >> $GITHUB_STEP_SUMMARY
          fi

  on_failure:
    name: âŒ ì‹¤íŒ¨ ì²˜ë¦¬
    runs-on: ubuntu-latest
    needs: [preflight, sync_cosing]
    if: failure()
    
    steps:
      - name: ðŸ“§ ì‹¤íŒ¨ ì•Œë¦¼
        run: |
          echo "## âŒ COSING ë™ê¸°í™” ì‹¤íŒ¨" >> $GITHUB_STEP_SUMMARY
          echo "ë™ê¸°í™” ìž‘ì—…ì´ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ” í™•ì¸ ì‚¬í•­" >> $GITHUB_STEP_SUMMARY
          echo "1. GitHub Secrets ì„¤ì • í™•ì¸" >> $GITHUB_STEP_SUMMARY
          echo "2. ì›¹ ë°©í™”ë²½(WAF) ë¡œê·¸ í™•ì¸" >> $GITHUB_STEP_SUMMARY
          echo "3. ì„œë²„ ë¡œê·¸ í™•ì¸ (api_fetch_logs í…Œì´ë¸”)" >> $GITHUB_STEP_SUMMARY
          
