name: RAG Knowledge Base Sync (Manual Resync Control)

# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# ğŸ“Œ ìµœì í™” ì„¤ì • ìš”ì•½
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# âœ… ë°°ì¹˜ í¬ê¸°: 100ê±´ (Supabase timeout ë°©ì§€)
# âœ… ì›Œì»¤ ìˆ˜: 2ê°œ (API rate limit ì¤€ìˆ˜)
# âœ… íƒ€ì„ì•„ì›ƒ: 180ë¶„ (ì¶©ë¶„í•œ ì²˜ë¦¬ ì‹œê°„)
# âœ… ëŒ€ê¸° ì‹œê°„: 3ì´ˆ (API ë¶€í•˜ ë¶„ì‚°)
# âœ… ì¦ë¶„ ë™ê¸°í™”: skip-synced=1 (ì¤‘ë³µ ë°©ì§€)
# âœ… ì¬ë™ê¸°í™”: ìˆ˜ë™ ì‹¤í–‰ ì‹œì—ë§Œ í™œì„±í™” (ì„¸ì…˜ íƒ€ì„ì•„ì›ƒ ë°©ì§€)
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

on:
  schedule:
    # ë§¤ì¼ ì˜¤í›„ 11ì‹œ 55ë¶„(í•œêµ­ì‹œê°„) ì‹¤í–‰
    # í•œêµ­ì‹œê°„(KST) = UTC + 9ì‹œê°„
    # 23:55 KST = 14:55 UTC
    - cron: '55 14 * * *'
  
  # ìˆ˜ë™ ì‹¤í–‰ ì˜µì…˜
  workflow_dispatch:
    inputs:
      batch_size:
        description: 'ë°°ì¹˜ í¬ê¸° (ê¸°ë³¸ê°’: 100)'
        required: false
        default: '100'
        type: choice
        options:
          - '50'
          - '100'
          - '150'
          - '200'
      workers:
        description: 'ì›Œì»¤ ìˆ˜ (ê¸°ë³¸ê°’: 2)'
        required: false
        default: '2'
        type: choice
        options:
          - '1'
          - '2'
          - '3'
          - '4'
      max_iterations:
        description: 'ì›Œì»¤ë‹¹ ìµœëŒ€ ë°˜ë³µ íšŸìˆ˜ (ê¸°ë³¸ê°’: 500)'
        required: false
        default: '500'
        type: choice
        options:
          - '100'
          - '200'
          - '500'
          - '1000'
      first_run:
        description: 'ì²« ì‹¤í–‰ ì—¬ë¶€ (Supabase ë¹„ì–´ìˆì„ ë•Œë§Œ true)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'
      # âœ… ì‹ ê·œ ì˜µì…˜: ì¬ë™ê¸°í™” í™œì„±í™”
      enable_resync:
        description: 'ğŸ”„ ìë™ ì¬ë™ê¸°í™” í™œì„±í™” (ê¶Œì¥: false)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

env:
  CAFE24_SYNC_URL: ${{ secrets.CAFE24_SYNC_URL }}
  SYNC_TOKEN: ${{ secrets.SYNC_TOKEN }}

jobs:
  preflight:
    name: ğŸ” ì‚¬ì „ ì§„ë‹¨
    runs-on: ubuntu-latest
    outputs:
      can_proceed: ${{ steps.check.outputs.can_proceed }}
      mysql_total: ${{ steps.stats.outputs.mysql_total }}
      supabase_synced: ${{ steps.stats.outputs.supabase_synced }}
      remaining: ${{ steps.stats.outputs.remaining }}
      is_first_run: ${{ steps.stats.outputs.is_first_run }}
      batch_size: ${{ steps.params.outputs.batch_size }}
      workers: ${{ steps.params.outputs.workers }}
      max_iterations: ${{ steps.params.outputs.max_iterations }}
      enable_resync: ${{ steps.params.outputs.enable_resync }}
      
    steps:
      - name: âš™ï¸ íŒŒë¼ë¯¸í„° ì„¤ì •
        id: params
        run: |
          # ìŠ¤ì¼€ì¤„ ì‹¤í–‰ vs ìˆ˜ë™ ì‹¤í–‰ êµ¬ë¶„
          if [ "${{ github.event_name }}" = "schedule" ]; then
            BATCH_SIZE=100
            WORKERS=2
            MAX_ITERATIONS=500
            ENABLE_RESYNC=false  # âœ… ìŠ¤ì¼€ì¤„ ì‹¤í–‰ ì‹œ ì¬ë™ê¸°í™” ë¹„í™œì„±í™”
            echo "ğŸ“… ìŠ¤ì¼€ì¤„ ì‹¤í–‰: ê¸°ë³¸ê°’ ì‚¬ìš© (ì¬ë™ê¸°í™” ë¹„í™œì„±í™”)"
          else
            BATCH_SIZE="${{ github.event.inputs.batch_size || '100' }}"
            WORKERS="${{ github.event.inputs.workers || '2' }}"
            MAX_ITERATIONS="${{ github.event.inputs.max_iterations || '500' }}"
            ENABLE_RESYNC="${{ github.event.inputs.enable_resync || 'false' }}"
            echo "ğŸ–±ï¸ ìˆ˜ë™ ì‹¤í–‰: ì‚¬ìš©ì ì…ë ¥ê°’ ì‚¬ìš©"
          fi
          
          echo "batch_size=$BATCH_SIZE" >> $GITHUB_OUTPUT
          echo "workers=$WORKERS" >> $GITHUB_OUTPUT
          echo "max_iterations=$MAX_ITERATIONS" >> $GITHUB_OUTPUT
          echo "enable_resync=$ENABLE_RESYNC" >> $GITHUB_OUTPUT
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âš™ï¸ ì‹¤í–‰ íŒŒë¼ë¯¸í„°"
          echo "  - ë°°ì¹˜ í¬ê¸°: ${BATCH_SIZE}"
          echo "  - ì›Œì»¤ ìˆ˜: ${WORKERS}"
          echo "  - ìµœëŒ€ ë°˜ë³µ: ${MAX_ITERATIONS}"
          echo "  - ğŸ”„ ì¬ë™ê¸°í™”: ${ENABLE_RESYNC}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      
      - name: ğŸ” í† í° ê²€ì¦
        id: check
        run: |
          if [ -z "${{ env.SYNC_TOKEN }}" ]; then
            echo "âŒ SYNC_TOKENì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
            echo "can_proceed=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          BASE_URL="${{ env.CAFE24_SYNC_URL }}"
          
          if [[ "$BASE_URL" == *"?"* ]]; then
            DIAG_URL="${BASE_URL}&t=${{ env.SYNC_TOKEN }}&diag=1"
          else
            DIAG_URL="${BASE_URL}?t=${{ env.SYNC_TOKEN }}&diag=1"
          fi
          
          RESPONSE=$(curl -s -w "\n%{http_code}" "$DIAG_URL")
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          if [ "$HTTP_CODE" != "200" ]; then
            echo "âŒ ì„œë²„ ì—°ê²° ì‹¤íŒ¨: HTTP $HTTP_CODE"
            echo "$BODY"
            echo "can_proceed=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          echo "âœ… í† í° ê²€ì¦ ì„±ê³µ"
          echo "can_proceed=true" >> $GITHUB_OUTPUT
      
      - name: ğŸ“Š í˜„ì¬ í†µê³„ ì¡°íšŒ
        id: stats
        if: steps.check.outputs.can_proceed == 'true'
        run: |
          echo "ğŸ“Š Supabase í†µê³„ ì¡°íšŒ ì¤‘..."
          
          BASE_URL="${{ env.CAFE24_SYNC_URL }}"
          BASE_DIR=$(dirname "$BASE_URL")
          
          STATS_URL="${BASE_DIR}/sync_stats.php?t=${{ env.SYNC_TOKEN }}"
          
          RESPONSE=$(curl -s "$STATS_URL")
          
          ERROR=$(echo "$RESPONSE" | jq -r '.error // empty')
          if [ -n "$ERROR" ]; then
            echo "âŒ í†µê³„ ì¡°íšŒ ì‹¤íŒ¨: $ERROR"
            exit 1
          fi
          
          MYSQL_TOTAL=$(echo "$RESPONSE" | jq -r '.mysql_total // 0')
          SUPABASE_SYNCED=$(echo "$RESPONSE" | jq -r '.supabase_synced // 0')
          SYNC_RATE=$(echo "$RESPONSE" | jq -r '.sync_rate // 0')
          REMAINING=$(echo "$RESPONSE" | jq -r '.remaining // 0')
          
          # ì²« ì‹¤í–‰ ì—¬ë¶€ íŒë‹¨
          IS_FIRST_RUN="${{ github.event.inputs.first_run || 'false' }}"
          if [ "$SUPABASE_SYNCED" -eq 0 ] && [ "$MYSQL_TOTAL" -gt 0 ]; then
            IS_FIRST_RUN="true"
            echo "ğŸ†• ì²« ì‹¤í–‰ ìë™ ê°ì§€"
          fi
          
          echo "mysql_total=$MYSQL_TOTAL" >> $GITHUB_OUTPUT
          echo "supabase_synced=$SUPABASE_SYNCED" >> $GITHUB_OUTPUT
          echo "sync_rate=$SYNC_RATE" >> $GITHUB_OUTPUT
          echo "remaining=$REMAINING" >> $GITHUB_OUTPUT
          echo "is_first_run=$IS_FIRST_RUN" >> $GITHUB_OUTPUT
          
          echo "### ğŸ“Š í˜„ì¬ í†µê³„" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| í•­ëª© | ê°’ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|---:|" >> $GITHUB_STEP_SUMMARY
          echo "| MySQL ì „ì²´ | ${MYSQL_TOTAL}ê±´ |" >> $GITHUB_STEP_SUMMARY
          echo "| Supabase ë™ê¸°í™” | ${SUPABASE_SYNCED}ê±´ |" >> $GITHUB_STEP_SUMMARY
          echo "| **ë™ê¸°í™”ìœ¨** | **${SYNC_RATE}%** |" >> $GITHUB_STEP_SUMMARY
          echo "| ë‚¨ì€ ë°ì´í„° | ${REMAINING}ê±´ |" >> $GITHUB_STEP_SUMMARY
          echo "| ì²« ì‹¤í–‰ | ${IS_FIRST_RUN} |" >> $GITHUB_STEP_SUMMARY

  sync:
    name: ğŸ”„ ì›Œì»¤ ${{ matrix.worker_id }}
    runs-on: ubuntu-latest
    needs: preflight
    if: needs.preflight.outputs.can_proceed == 'true' && needs.preflight.outputs.remaining > 0
    timeout-minutes: 480
    
    strategy:
      max-parallel: ${{ fromJSON(needs.preflight.outputs.workers) }}
      matrix:
        worker_id: [0, 1, 2, 3]
    
    steps:
      - name: ğŸš€ ë°˜ë³µ ë°°ì¹˜ ë™ê¸°í™” ì‹¤í–‰
        if: matrix.worker_id < fromJSON(needs.preflight.outputs.workers)
        id: sync_batches
        env:
          BATCH_SIZE: ${{ needs.preflight.outputs.batch_size }}
          WORKER_ID: ${{ matrix.worker_id }}
          MAX_ITERATIONS: ${{ needs.preflight.outputs.max_iterations }}
          IS_FIRST_RUN: ${{ needs.preflight.outputs.is_first_run }}
          WORKERS: ${{ needs.preflight.outputs.workers }}
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸš€ ì›Œì»¤ #${WORKER_ID} ì‹œì‘"
          echo "  - ë°°ì¹˜ í¬ê¸°: ${BATCH_SIZE}"
          echo "  - ìµœëŒ€ ë°˜ë³µ: ${MAX_ITERATIONS}"
          echo "  - ì²« ì‹¤í–‰: ${IS_FIRST_RUN}"
          echo "  - ì „ì²´ ì›Œì»¤: ${WORKERS}ê°œ"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          BASE_URL="${{ env.CAFE24_SYNC_URL }}"
          SYNC_TOKEN="${{ env.SYNC_TOKEN }}"
          
          # ì²« ì‹¤í–‰ì´ë©´ skip-synced=0
          if [ "$IS_FIRST_RUN" = "true" ]; then
            SKIP_SYNCED=0
            echo "ğŸ“Œ ì²« ì‹¤í–‰: ì¤‘ë³µ ì²´í¬ ë¹„í™œì„±í™”"
          else
            SKIP_SYNCED=1
            echo "ğŸ“Œ ì¬ì‹¤í–‰: ì¤‘ë³µ ì²´í¬ í™œì„±í™”"
          fi
          
          ITERATION=0
          TOTAL_PROCESSED=0
          TOTAL_UPSERTED=0
          OFFSET=$((WORKER_ID * BATCH_SIZE))
          
          while [ $ITERATION -lt $MAX_ITERATIONS ]; do
            ITERATION=$((ITERATION + 1))
            
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ”„ ì›Œì»¤ #${WORKER_ID} - ë°˜ë³µ ${ITERATION}/${MAX_ITERATIONS}"
            echo "  - ì˜¤í”„ì…‹: ${OFFSET}"
            echo "  - ë°°ì¹˜ í¬ê¸°: ${BATCH_SIZE}"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            
            # URL êµ¬ì„±
            if [[ "$BASE_URL" == *"?"* ]]; then
              SYNC_URL="${BASE_URL}&t=${SYNC_TOKEN}&batch=${BATCH_SIZE}&offset=${OFFSET}&skip-synced=${SKIP_SYNCED}"
            else
              SYNC_URL="${BASE_URL}?t=${SYNC_TOKEN}&batch=${BATCH_SIZE}&offset=${OFFSET}&skip-synced=${SKIP_SYNCED}"
            fi
            
            echo "ğŸ”— ìš”ì²­ URL: ...?t=***&batch=${BATCH_SIZE}&offset=${OFFSET}&skip-synced=${SKIP_SYNCED}"
            
            # HTTP ìš”ì²­
            RESPONSE=$(curl -s -w "\n%{http_code}" "$SYNC_URL")
            HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
            BODY=$(echo "$RESPONSE" | sed '$d')
            
            echo "ğŸ“Š HTTP ì‘ë‹µ: ${HTTP_CODE}"
            
            if [ "$HTTP_CODE" != "200" ]; then
              echo "âŒ HTTP ì˜¤ë¥˜: ${HTTP_CODE}"
              echo "$BODY" | jq '.' 2>/dev/null || echo "$BODY" | head -c 500
              echo "â¸ï¸ 10ì´ˆ í›„ ì¬ì‹œë„..."
              sleep 10
              continue
            fi
            
            # JSON íŒŒì‹±
            echo "$BODY" | jq '.' > /dev/null 2>&1
            if [ $? -ne 0 ]; then
              echo "âš ï¸ JSON íŒŒì‹± ì‹¤íŒ¨"
              echo "$BODY" | head -c 500
              sleep 5
              continue
            fi
            
            # ê²°ê³¼ í™•ì¸
            OK=$(echo "$BODY" | jq -r '.ok // false')
            PROCESSED=$(echo "$BODY" | jq -r '.batch.processed // 0')
            UPSERTED=$(echo "$BODY" | jq -r '.batch.upserted // 0')
            DUPLICATE=$(echo "$BODY" | jq -r '.batch.duplicate_skipped // 0')
            HAS_MORE=$(echo "$BODY" | jq -r '.config.has_more // false')
            
            echo "âœ… ì²˜ë¦¬ ì™„ë£Œ:"
            echo "  - ì²˜ë¦¬: ${PROCESSED}ê±´"
            echo "  - ì—…ë¡œë“œ: ${UPSERTED}ê±´"
            echo "  - ì¤‘ë³µ: ${DUPLICATE}ê±´"
            echo "  - ì¶”ê°€ ë°ì´í„°: ${HAS_MORE}"
            
            TOTAL_PROCESSED=$((TOTAL_PROCESSED + PROCESSED))
            TOTAL_UPSERTED=$((TOTAL_UPSERTED + UPSERTED))
            
            # ì¢…ë£Œ ì¡°ê±´
            if [ "$PROCESSED" -eq 0 ] || [ "$HAS_MORE" = "false" ]; then
              echo "ğŸ ë” ì´ìƒ ì²˜ë¦¬í•  ë°ì´í„° ì—†ìŒ"
              break
            fi
            
            # ë‹¤ìŒ ì˜¤í”„ì…‹ (ì›Œì»¤ ìˆ˜ë§Œí¼ ì í”„)
            OFFSET=$((OFFSET + BATCH_SIZE * WORKERS))
            
            # API ë¶€í•˜ ë¶„ì‚°
            sleep 3
          done
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… ì›Œì»¤ #${WORKER_ID} ì™„ë£Œ"
          echo "  - ì´ ë°˜ë³µ: ${ITERATION}íšŒ"
          echo "  - ì´ ì²˜ë¦¬: ${TOTAL_PROCESSED}ê±´"
          echo "  - ì´ ì—…ë¡œë“œ: ${TOTAL_UPSERTED}ê±´"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  # ================== [í•µì‹¬ ìˆ˜ì •] ì¬ë™ê¸°í™” ì‘ì—… ë¡œì§ ë³€ê²½ ==================
  auto_resync:
    name: ğŸ”„ ìë™ ì¬ë™ê¸°í™” (ë°˜ë³µ ì‹¤í–‰)
    runs-on: ubuntu-latest
    needs: [preflight, sync]
    if: |
      always() && 
      needs.preflight.outputs.can_proceed == 'true' && 
      needs.preflight.outputs.enable_resync == 'true' &&
      (needs.sync.result == 'success' || needs.sync.result == 'skipped')
    
    steps:
      - name: ğŸ”„ ë°˜ë³µ ì¬ë™ê¸°í™” ì‹¤í–‰
        env:
          MAX_RESYNC_ITERATIONS: 10 # ë¬´í•œ ë£¨í”„ ë°©ì§€ë¥¼ ìœ„í•œ ìµœëŒ€ ë°˜ë³µ íšŸìˆ˜
        run: |
          echo "### ğŸ”„ ì¬ë™ê¸°í™” í”„ë¡œì„¸ìŠ¤ ì‹œì‘" >> $GITHUB_STEP_SUMMARY
          
          BASE_URL="${{ env.CAFE24_SYNC_URL }}"
          BASE_DIR=$(dirname "$BASE_URL")
          STATS_URL="${BASE_DIR}/sync_stats.php?t=${{ env.SYNC_TOKEN }}"
          RESYNC_URL="${STATS_URL}&action=auto_resync"
          
          ITERATION=0
          while [ $ITERATION -lt $MAX_RESYNC_ITERATIONS ]; do
            ITERATION=$((ITERATION + 1))
            
            echo ""
            echo "---"
            echo "ğŸ”„ ì¬ë™ê¸°í™” ë°˜ë³µ #${ITERATION}/${MAX_RESYNC_ITERATIONS}"
            
            # 1. í˜„ì¬ ìƒíƒœ í™•ì¸
            echo "ğŸ“Š í˜„ì¬ í†µê³„ ì¡°íšŒ ì¤‘..."
            STATS_RESPONSE=$(curl -s "$STATS_URL")
            REMAINING=$(echo "$STATS_RESPONSE" | jq -r '.remaining // -1')
            SYNC_RATE=$(echo "$STATS_RESPONSE" | jq -r '.sync_rate // 0')
            
            echo "  - ë‚¨ì€ ë°ì´í„°: ${REMAINING}ê±´"
            echo "  - ë™ê¸°í™”ìœ¨: ${SYNC_RATE}%"
            
            if [ "$REMAINING" -eq 0 ]; then
              echo "ğŸ‰ 100% ë™ê¸°í™” ì™„ë£Œ! ì¬ë™ê¸°í™”ë¥¼ ì¢…ë£Œí•©ë‹ˆë‹¤."
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**âœ… ì¬ë™ê¸°í™” ì„±ê³µ**" >> $GITHUB_STEP_SUMMARY
              echo "> ëª¨ë“  ë‚¨ì€ ë°ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ë™ê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
              break
            elif [ "$REMAINING" -lt 0 ]; then
              echo "âŒ í†µê³„ ì¡°íšŒ ì‹¤íŒ¨. ì¬ë™ê¸°í™”ë¥¼ ì¤‘ë‹¨í•©ë‹ˆë‹¤."
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**âš ï¸ ì¬ë™ê¸°í™” ì˜¤ë¥˜**" >> $GITHUB_STEP_SUMMARY
              echo "> í†µê³„ ì¡°íšŒì— ì‹¤íŒ¨í•˜ì—¬ í”„ë¡œì„¸ìŠ¤ë¥¼ ì¤‘ë‹¨í–ˆìŠµë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
              exit 1
            fi
            
            # 2. ì¬ë™ê¸°í™” íŠ¸ë¦¬ê±°
            echo "ğŸš€ ì¬ë™ê¸°í™” íŠ¸ë¦¬ê±° ìš”ì²­..."
            RESYNC_RESPONSE=$(curl -s "$RESYNC_URL")
            echo "$RESYNC_RESPONSE" | jq '.'
            
            # 3. ë‹¤ìŒ ë°°ì¹˜ê°€ ì²˜ë¦¬ë  ë•Œê¹Œì§€ ëŒ€ê¸° (60ì´ˆ)
            echo "â³ ë‹¤ìŒ ë°°ì¹˜ê°€ ì²˜ë¦¬ë  ë•Œê¹Œì§€ 60ì´ˆ ëŒ€ê¸°..."
            sleep 60
          done
          
          if [ $ITERATION -ge $MAX_RESYNC_ITERATIONS ]; then
            echo "âš ï¸ ìµœëŒ€ ë°˜ë³µ íšŸìˆ˜ ë„ë‹¬. ì›Œí¬í”Œë¡œìš°ë¥¼ ì¢…ë£Œí•©ë‹ˆë‹¤."
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**âš ï¸ ì¬ë™ê¸°í™” ì‹œê°„ ì´ˆê³¼**" >> $GITHUB_STEP_SUMMARY
            echo "> ìµœëŒ€ ë°˜ë³µ íšŸìˆ˜ì— ë„ë‹¬í•˜ì—¬ í”„ë¡œì„¸ìŠ¤ë¥¼ ì¢…ë£Œí–ˆìŠµë‹ˆë‹¤. ë‚¨ì€ ë°ì´í„°ëŠ” ë‹¤ìŒ ìŠ¤ì¼€ì¤„ì— ì²˜ë¦¬ë©ë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
          fi
  # =======================================================================

  finalize:
    name: ğŸ“Š ìµœì¢… í†µê³„
    runs-on: ubuntu-latest
    needs: [preflight, sync, auto_resync]
    if: always() && needs.preflight.outputs.can_proceed == 'true'
    
    steps:
      - name: ğŸ“Š ìµœì¢… í†µê³„ ì¡°íšŒ
        run: |
          echo "ğŸ“Š ìµœì¢… Supabase í†µê³„ ì¡°íšŒ ì¤‘..."
          
          BASE_URL="${{ env.CAFE24_SYNC_URL }}"
          BASE_DIR=$(dirname "$BASE_URL")
          
          STATS_URL="${BASE_DIR}/sync_stats.php?t=${{ env.SYNC_TOKEN }}"
          
          # ì¬ë™ê¸°í™”ê°€ ì‹¤í–‰ë˜ì—ˆë‹¤ë©´, ìµœì¢… ê²°ê³¼ë¥¼ ë°˜ì˜í•˜ê¸° ìœ„í•´ ì¶©ë¶„íˆ ëŒ€ê¸°
          if [ "${{ needs.preflight.outputs.enable_resync }}" = "true" ]; then
            echo "â³ ì¬ë™ê¸°í™” ìµœì¢… ê²°ê³¼ ë°˜ì˜ì„ ìœ„í•´ 30ì´ˆ ëŒ€ê¸°..."
            sleep 30
          fi
          
          RESPONSE=$(curl -s "$STATS_URL")
          
          MYSQL_TOTAL=$(echo "$RESPONSE" | jq -r '.mysql_total // 0')
          SUPABASE_SYNCED=$(echo "$RESPONSE" | jq -r '.supabase_synced // 0')
          SYNC_RATE=$(echo "$RESPONSE" | jq -r '.sync_rate // 0')
          REMAINING=$(echo "$RESPONSE" | jq -r '.remaining // 0')
          
          # ì¬ë™ê¸°í™” ìƒíƒœ í™•ì¸
          RESYNC_ENABLED="${{ needs.preflight.outputs.enable_resync }}"
          RESYNC_STATUS="âŒ OFF (ê¶Œì¥)"
          if [ "$RESYNC_ENABLED" = "true" ]; then
            RESYNC_STATUS="âœ… ON"
          fi
          
          echo "### ğŸŒ ì „ì²´ ë™ê¸°í™” í˜„í™©" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| í•­ëª© | ê°’ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|---:|" >> $GITHUB_STEP_SUMMARY
          echo "| MySQL ì „ì²´ ë ˆì½”ë“œ | ${MYSQL_TOTAL}ê±´ |" >> $GITHUB_STEP_SUMMARY
          echo "| Supabase ë™ê¸°í™” ì™„ë£Œ | ${SUPABASE_SYNCED}ê±´ |" >> $GITHUB_STEP_SUMMARY
          echo "| **ë™ê¸°í™”ìœ¨** | **${SYNC_RATE}%** |" >> $GITHUB_STEP_SUMMARY
          echo "| ë‚¨ì€ ë°ì´í„° | ${REMAINING}ê±´ |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âš™ï¸ ì‹¤í–‰ íŒŒë¼ë¯¸í„°" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **ë°°ì¹˜ í¬ê¸°**: ${{ needs.preflight.outputs.batch_size }}ê±´" >> $GITHUB_STEP_SUMMARY
          echo "- **ì›Œì»¤ ìˆ˜**: ${{ needs.preflight.outputs.workers }}ê°œ" >> $GITHUB_STEP_SUMMARY
          echo "- **ìµœëŒ€ ë°˜ë³µ**: ${{ needs.preflight.outputs.max_iterations }}íšŒ" >> $GITHUB_STEP_SUMMARY
          echo "- **ğŸ”„ ìë™ ì¬ë™ê¸°í™”**: ${RESYNC_STATUS}" >> $GITHUB_STEP_SUMMARY
          echo "- **ì™„ë£Œ ì‹œê°„**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "$REMAINING" -eq 0 ]; then
            echo "## âœ… ë™ê¸°í™” ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ëª¨ë“  ë°ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ë™ê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ‰" >> $GITHUB_STEP_SUMMARY
          else
            echo "## ğŸ”„ ë™ê¸°í™” ì§„í–‰ ì¤‘" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ë‹¤ìŒ ìŠ¤ì¼€ì¤„ì—ì„œ ê³„ì† ì§„í–‰ë©ë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
          fi
          
          # ì¬ë™ê¸°í™” ê´€ë ¨ ì•ˆë‚´
          if [ "$RESYNC_ENABLED" = "false" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ğŸ’¡ ì¬ë™ê¸°í™” ì•ˆë‚´" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "í˜„ì¬ ìë™ ì¬ë™ê¸°í™”ê°€ **ë¹„í™œì„±í™”** ìƒíƒœì…ë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
            echo "í•„ìš” ì‹œ ìˆ˜ë™ ì‹¤í–‰ì—ì„œ 'ğŸ”„ ìë™ ì¬ë™ê¸°í™” í™œì„±í™”' ì˜µì…˜ì„ trueë¡œ ì„¤ì •í•˜ì„¸ìš”." >> $GITHUB_STEP_SUMMARY
          fi
          
