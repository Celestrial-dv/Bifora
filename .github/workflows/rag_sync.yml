name: RAG Knowledge Base Sync (Optimized & Stable)

# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# ðŸ“Œ ìµœì í™” ì„¤ì • ìš”ì•½
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# âœ… ë°°ì¹˜ í¬ê¸°: 100ê±´ (Supabase timeout ë°©ì§€)
# âœ… ì›Œì»¤ ìˆ˜: 2ê°œ (API rate limit ì¤€ìˆ˜)
# âœ… íƒ€ìž„ì•„ì›ƒ: 180ë¶„ (ì¶©ë¶„í•œ ì²˜ë¦¬ ì‹œê°„)
# âœ… ëŒ€ê¸° ì‹œê°„: 3ì´ˆ (API ë¶€í•˜ ë¶„ì‚°)
# âœ… ì¦ë¶„ ë™ê¸°í™”: skip-synced=1 (ì¤‘ë³µ ë°©ì§€)
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

on:
  schedule:
    # ë§¤ì¼ ì˜¤í›„ 11ì‹œ 55ë¶„(í•œêµ­ì‹œê°„) ì‹¤í–‰
    # í•œêµ­ì‹œê°„(KST) = UTC + 9ì‹œê°„
    # 23:55 KST = 14:55 UTC
    - cron: '55 14 * * *'
  
  # ìˆ˜ë™ ì‹¤í–‰ ì˜µì…˜
  workflow_dispatch:
    inputs:
      batch_size:
        description: 'ë°°ì¹˜ í¬ê¸° (ê¶Œìž¥: 100)'
        required: false
        default: '100'
      parallel_workers:
        description: 'ì›Œì»¤ ìˆ˜ (ê¶Œìž¥: 2, ìµœëŒ€: 4)'
        required: false
        default: '2'
      since:
        description: 'ë™ê¸°í™” ì‹œìž‘ ë‚ ì§œ (ì˜ˆ: 2025-01-01)'
        required: false
        default: ''
      skip_synced:
        description: 'ì´ë¯¸ ë™ê¸°í™”ëœ ë°ì´í„° ê±´ë„ˆë›°ê¸° (1=ì˜ˆ, 0=ì•„ë‹ˆì˜¤)'
        required: false
        default: '1'

env:
  WEBHOOK_URL: ${{ secrets.CAFE24_SYNC_URL }}
  SYNC_TOKEN: ${{ secrets.SYNC_TOKEN }}
  BATCH_SIZE: ${{ github.event.inputs.batch_size || '100' }}
  PARALLEL_WORKERS: ${{ github.event.inputs.parallel_workers || '2' }}
  SINCE: ${{ github.event.inputs.since || '' }}
  SKIP_SYNCED: ${{ github.event.inputs.skip_synced || '1' }}
  MAX_ITERATIONS: 300
  SLEEP_SECONDS: 3

jobs:
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # ðŸ” ì‚¬ì „ ì§„ë‹¨: ì„œë²„ ìƒíƒœ ë° í† í° ê²€ì¦
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  pre-check:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: ðŸ“‹ Checkout
        uses: actions/checkout@v4

      - name: ðŸ” Server Diagnostic
        id: diag
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ” ì„œë²„ í™˜ê²½ ì§„ë‹¨ ì‹œìž‘"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          DIAG_URL="${WEBHOOK_URL}/sync_webhook.php?diag=1&t=${SYNC_TOKEN}"
          
          RESPONSE=$(curl -sS -w "\n%{http_code}" "$DIAG_URL")
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          echo "HTTP Status: $HTTP_CODE"
          echo "$BODY" | jq '.' || echo "$BODY"
          
          if [ "$HTTP_CODE" != "200" ]; then
            echo "::error::ì§„ë‹¨ ì‹¤íŒ¨: HTTP $HTTP_CODE"
            exit 1
          fi
          
          TOKEN_OK=$(echo "$BODY" | jq -r '.token_match // false')
          EXEC_OK=$(echo "$BODY" | jq -r '.env.exec_allowed // false')
          PHP_CLI=$(echo "$BODY" | jq -r '.php_cli.found // "none"')
          
          echo "::notice::âœ… í† í° ê²€ì¦: $TOKEN_OK"
          echo "::notice::âœ… exec í—ˆìš©: $EXEC_OK"
          echo "::notice::âœ… PHP CLI: $PHP_CLI"
          
          if [ "$TOKEN_OK" != "true" ]; then
            echo "::error::í† í° ë¶ˆì¼ì¹˜"
            exit 1
          fi
          
          echo "token_valid=$TOKEN_OK" >> $GITHUB_OUTPUT
          echo "exec_allowed=$EXEC_OK" >> $GITHUB_OUTPUT

      - name: ðŸ“Š Diagnostic Summary
        run: |
          echo "## ðŸ” ì‚¬ì „ ì§„ë‹¨ ê²°ê³¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| í•­ëª© | ìƒíƒœ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| í† í° ê²€ì¦ | âœ… í†µê³¼ |" >> $GITHUB_STEP_SUMMARY
          echo "| ì„œë²„ ì—°ê²° | âœ… ì •ìƒ |" >> $GITHUB_STEP_SUMMARY
          echo "| ë°°ì¹˜ í¬ê¸° | ${{ env.BATCH_SIZE }}ê±´ |" >> $GITHUB_STEP_SUMMARY
          echo "| ì›Œì»¤ ìˆ˜ | ${{ env.PARALLEL_WORKERS }}ê°œ |" >> $GITHUB_STEP_SUMMARY
          echo "| ì¦ë¶„ ë™ê¸°í™” | ${{ env.SKIP_SYNCED == '1' && 'í™œì„±í™”' || 'ë¹„í™œì„±í™”' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # ðŸ”„ ë³‘ë ¬ ë™ê¸°í™”: 2ê°œ ì›Œì»¤ë¡œ ì•ˆì •ì  ì²˜ë¦¬
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  sync:
    needs: pre-check
    runs-on: ubuntu-latest
    timeout-minutes: 180  # â±ï¸ 3ì‹œê°„ íƒ€ìž„ì•„ì›ƒ
    
    strategy:
      matrix:
        worker: [0, 1]  # ðŸ”§ 2ê°œ ì›Œì»¤ ê³ ì •
      fail-fast: false
      max-parallel: 2
    
    steps:
      - name: ðŸ“‹ Checkout
        uses: actions/checkout@v4

      - name: ðŸ”„ Parallel Sync (Worker ${{ matrix.worker }})
        id: sync
        run: |
          WORKER_ID=${{ matrix.worker }}
          TOTAL_WORKERS=${{ env.PARALLEL_WORKERS }}
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸš€ ì›Œì»¤ #${WORKER_ID} ì‹œìž‘"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ“¦ ë°°ì¹˜ í¬ê¸°: ${BATCH_SIZE}ê±´"
          echo "ðŸ‘¥ ì´ ì›Œì»¤ ìˆ˜: ${TOTAL_WORKERS}ê°œ"
          echo "ðŸ”„ ì¦ë¶„ ë™ê¸°í™”: ${{ env.SKIP_SYNCED == '1' && 'í™œì„±í™”' || 'ë¹„í™œì„±í™”' }}"
          echo "ðŸ“… ì‹œìž‘ ë‚ ì§œ: ${SINCE:-ì „ì²´}"
          echo ""
          
          # â˜… ì›Œì»¤ë³„ ì‹œìž‘ ì˜¤í”„ì…‹
          OFFSET=$((BATCH_SIZE * WORKER_ID))
          
          TOTAL_PROCESSED=0
          TOTAL_UPSERTED=0
          TOTAL_SKIPPED=0
          ITERATION=0
          HAS_MORE="true"
          CONSECUTIVE_FAILURES=0
          
          while [ "$HAS_MORE" = "true" ] && [ $ITERATION -lt $MAX_ITERATIONS ]; do
            ITERATION=$((ITERATION + 1))
            
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ðŸ“¦ ì›Œì»¤ #${WORKER_ID} - ë°°ì¹˜ #${ITERATION}"
            echo "   offset=${OFFSET}, batch=${BATCH_SIZE}"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            
            # â˜… ì¦ë¶„ ë™ê¸°í™” íŒŒë¼ë¯¸í„° í¬í•¨
            SYNC_URL="${WEBHOOK_URL}/sync_webhook.php"
            PARAMS="t=${SYNC_TOKEN}"
            PARAMS="${PARAMS}&batch=${BATCH_SIZE}"
            PARAMS="${PARAMS}&offset=${OFFSET}"
            PARAMS="${PARAMS}&async=0"
            PARAMS="${PARAMS}&skip-synced=${SKIP_SYNCED}"
            
            if [ -n "$SINCE" ]; then
              PARAMS="${PARAMS}&s=${SINCE}"
            fi
            
            FULL_URL="${SYNC_URL}?${PARAMS}"
            
            # â˜… ìž¬ì‹œë„ ë¡œì§ í¬í•¨
            MAX_RETRIES=3
            RETRY=0
            SUCCESS=false
            
            while [ $RETRY -lt $MAX_RETRIES ] && [ "$SUCCESS" = "false" ]; do
              if [ $RETRY -gt 0 ]; then
                BACKOFF=$((RETRY * 5))
                echo "â³ ìž¬ì‹œë„ #${RETRY} - ${BACKOFF}ì´ˆ ëŒ€ê¸° ì¤‘..."
                sleep $BACKOFF
              fi
              
              RESPONSE=$(curl -sS -w "\n%{http_code}" --max-time 300 "$FULL_URL")
              HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
              BODY=$(echo "$RESPONSE" | sed '$d')
              
              echo "HTTP Status: $HTTP_CODE"
              
              if [ "$HTTP_CODE" = "200" ]; then
                SUCCESS=true
                CONSECUTIVE_FAILURES=0
              else
                RETRY=$((RETRY + 1))
                echo "::warning::ìš”ì²­ ì‹¤íŒ¨ (HTTP $HTTP_CODE), ìž¬ì‹œë„ ${RETRY}/${MAX_RETRIES}"
              fi
            done
            
            if [ "$SUCCESS" != "true" ]; then
              CONSECUTIVE_FAILURES=$((CONSECUTIVE_FAILURES + 1))
              echo "::error::ì›Œì»¤ #${WORKER_ID} ë°°ì¹˜ #${ITERATION} ì‹¤íŒ¨ (ì—°ì† ì‹¤íŒ¨: ${CONSECUTIVE_FAILURES})"
              echo "$BODY"
              
              if [ $CONSECUTIVE_FAILURES -ge 3 ]; then
                echo "::error::ì—°ì† 3íšŒ ì‹¤íŒ¨ë¡œ ì›Œì»¤ ì¤‘ë‹¨"
                break
              fi
              
              sleep $((SLEEP_SECONDS * 2))
              continue
            fi
            
            # JSON íŒŒì‹±
            PROCESSED=$(echo "$BODY" | jq -r '.processed // 0')
            UPSERTED=$(echo "$BODY" | jq -r '.upserted // 0')
            HAS_MORE=$(echo "$BODY" | jq -r '.has_more // false')
            SKIPPED=$(echo "$BODY" | jq -r '.skipped_existing // 0')
            
            TOTAL_PROCESSED=$((TOTAL_PROCESSED + PROCESSED))
            TOTAL_UPSERTED=$((TOTAL_UPSERTED + UPSERTED))
            TOTAL_SKIPPED=$((TOTAL_SKIPPED + SKIPPED))
            
            echo "âœ… ì²˜ë¦¬: ${PROCESSED}ê±´, ì—…ë¡œë“œ: ${UPSERTED}ê±´, ê±´ë„ˆëœ€: ${SKIPPED}ê±´"
            echo "ðŸ“Š ì›Œì»¤ #${WORKER_ID} ëˆ„ì :"
            echo "   - ì´ ì²˜ë¦¬: ${TOTAL_PROCESSED}ê±´"
            echo "   - ì´ ì—…ë¡œë“œ: ${TOTAL_UPSERTED}ê±´"
            echo "   - ì´ ê±´ë„ˆëœ€: ${TOTAL_SKIPPED}ê±´"
            echo "ðŸ”„ ë‹¤ìŒ ë°°ì¹˜: $([ "$HAS_MORE" = "true" ] && echo "ìžˆìŒ" || echo "ì—†ìŒ")"
            
            # â˜… ë‹¤ìŒ ì˜¤í”„ì…‹ = í˜„ìž¬ + (ë°°ì¹˜ í¬ê¸° Ã— ì „ì²´ ì›Œì»¤ ìˆ˜)
            OFFSET=$((OFFSET + BATCH_SIZE * TOTAL_WORKERS))
            
            if [ "$HAS_MORE" != "true" ]; then
              echo ""
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo "ðŸŽ‰ ì›Œì»¤ #${WORKER_ID} ì™„ë£Œ!"
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo "ì´ ë°°ì¹˜ ìˆ˜: ${ITERATION}"
              echo "ì´ ì²˜ë¦¬: ${TOTAL_PROCESSED}ê±´"
              echo "ì´ ì—…ë¡œë“œ: ${TOTAL_UPSERTED}ê±´"
              echo "ì´ ê±´ë„ˆëœ€: ${TOTAL_SKIPPED}ê±´"
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              break
            fi
            
            # â˜… API rate limit ì¤€ìˆ˜ë¥¼ ìœ„í•œ ëŒ€ê¸°
            sleep $SLEEP_SECONDS
          done
          
          if [ $ITERATION -ge $MAX_ITERATIONS ]; then
            echo "::warning::ì›Œì»¤ #${WORKER_ID} ìµœëŒ€ ë°˜ë³µ íšŸìˆ˜(${MAX_ITERATIONS}) ë„ë‹¬"
          fi
          
          # GitHub Actions Output ì„¤ì •
          echo "total_processed=$TOTAL_PROCESSED" >> $GITHUB_OUTPUT
          echo "total_upserted=$TOTAL_UPSERTED" >> $GITHUB_OUTPUT
          echo "total_skipped=$TOTAL_SKIPPED" >> $GITHUB_OUTPUT
          echo "iterations=$ITERATION" >> $GITHUB_OUTPUT
          echo "worker_id=$WORKER_ID" >> $GITHUB_OUTPUT

      - name: ðŸ“Š Worker Summary
        if: always()
        run: |
          echo "## ðŸ”„ ì›Œì»¤ #${{ matrix.worker }} ê²°ê³¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| í•­ëª© | ê°’ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| ì›Œì»¤ ID | ${{ matrix.worker }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ë°°ì¹˜ ìˆ˜ | ${{ steps.sync.outputs.iterations || '0' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ì²˜ë¦¬ ê±´ìˆ˜ | ${{ steps.sync.outputs.total_processed || '0' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ì—…ë¡œë“œ ê±´ìˆ˜ | ${{ steps.sync.outputs.total_upserted || '0' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ê±´ë„ˆëœ€ ê±´ìˆ˜ | ${{ steps.sync.outputs.total_skipped || '0' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # ðŸ“Š ìµœì¢… ìš”ì•½
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  summary:
    needs: sync
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: ðŸ“Š Final Summary
        run: |
          echo "## ðŸŽ‰ ì „ì²´ ë™ê¸°í™” ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ ì‹¤í–‰ ì •ë³´" >> $GITHUB_STEP_SUMMARY
          echo "- **ì›Œì»¤ ìˆ˜**: ${{ env.PARALLEL_WORKERS }}ê°œ" >> $GITHUB_STEP_SUMMARY
          echo "- **ë°°ì¹˜ í¬ê¸°**: ${{ env.BATCH_SIZE }}ê±´" >> $GITHUB_STEP_SUMMARY
          echo "- **ì¦ë¶„ ë™ê¸°í™”**: ${{ env.SKIP_SYNCED == '1' && 'âœ… í™œì„±í™”' || 'âŒ ë¹„í™œì„±í™”' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ì™„ë£Œ ì‹œê°„**: $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Œ ì°¸ê³ ì‚¬í•­" >> $GITHUB_STEP_SUMMARY
          echo "- ê° ì›Œì»¤ë³„ ìƒì„¸ ê²°ê³¼ëŠ” ìœ„ ì„¹ì…˜ì„ í™•ì¸í•˜ì„¸ìš”" >> $GITHUB_STEP_SUMMARY
          echo "- ì¤‘ë³µ ì²´í¬ëŠ” (infodata_id, content) ê¸°ì¤€ìœ¼ë¡œ ìˆ˜í–‰ë©ë‹ˆë‹¤" >> $GITHUB_STEP_SUMMARY
          echo "- ì¦ë¶„ ë™ê¸°í™” í™œì„±í™” ì‹œ ì´ë¯¸ ë™ê¸°í™”ëœ ë°ì´í„°ëŠ” ìžë™ìœ¼ë¡œ ê±´ë„ˆëœë‹ˆë‹¤" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— ìœ ìš©í•œ ë§í¬" >> $GITHUB_STEP_SUMMARY
          echo "- [Supabase ëŒ€ì‹œë³´ë“œ](https://supabase.com/dashboard)" >> $GITHUB_STEP_SUMMARY
          echo "- [ë™ê¸°í™” ë¡œê·¸ í™•ì¸](/logs/sync_to_supabase.log)" >> $GITHUB_STEP_SUMMARY
          
