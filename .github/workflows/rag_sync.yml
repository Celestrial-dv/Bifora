name: RAG Sync (Cafe24 → Supabase)

on:
  schedule:
    - cron: '0 17 * * *'   # 02:00 KST
  workflow_dispatch:
    inputs:
      mode:  { description: 'full | incremental', required: false, default: 'incremental' }
      since: { description: 'YYYY-MM-DD (optional)', required: false, default: '' }
      async: { description: '1=background,0=sync', required: false, default: '1' }

jobs:
  call-webhook:
    runs-on: ubuntu-latest
    steps:
      - name: Validate secrets
        run: |
          [ -n "${{ secrets.CAFE24_SYNC_URL }}" ] || (echo "CAFE24_SYNC_URL missing" && exit 1)
          [ -n "${{ secrets.SYNC_TOKEN }}" ] || (echo "SYNC_TOKEN missing" && exit 1)

      - name: Call Cafe24 sync webhook (capture body)
        env:
          URL:   ${{ secrets.CAFE24_SYNC_URL }}
          TOKEN: ${{ secrets.SYNC_TOKEN }}
          MODE:  ${{ github.event.inputs.mode  || 'incremental' }}
          SINCE: ${{ github.event.inputs.since || '' }}
          ASYNC: ${{ github.event.inputs.async || '1' }}
        run: |
          echo "URL=$URL"
          BODY="{\"mode\":\"$MODE\",\"since\":\"$SINCE\",\"async\":\"$ASYNC\"}"
          echo "Payload=$BODY"
          # 응답 헤더/본문 저장 (실패시에도 본문 확인)
          curl -sS -X POST "$URL" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $TOKEN" \
            -d "$BODY" \
            -D headers.txt -o body.txt -w "\nHTTP_CODE=%{http_code}\n"
          echo "----- response headers -----"
          cat headers.txt
          echo "----- response body -----"
          cat body.txt
          CODE=$(grep HTTP_CODE body.txt || true)
          # 200/202만 성공 처리
          if grep -q "HTTP_CODE=20" body.txt; then
            echo "OK"
          else
            echo "Request failed"; exit 1
          fi
