name: RAG Sync (Cafe24 → Supabase)

on:
  workflow_dispatch:
    inputs:
      mode:  { description: 'full | incremental', required: false, default: 'full' }
      since: { description: 'YYYY-MM-DD (optional)', required: false, default: '' }
      async: { description: '1=background,0=sync', required: false, default: '0' }  # ← 먼저 0

  schedule:
    - cron: '0 17 * * *'   # 02:00 KST (자동화 전, 수동으로 먼저)

jobs:
  call-webhook:
    runs-on: ubuntu-latest
    steps:
      - name: Validate secrets
        run: |
          [ -n "${{ secrets.CAFE24_SYNC_URL }}" ] || (echo "CAFE24_SYNC_URL missing" && exit 1)
          [ -n "${{ secrets.SYNC_TOKEN }}" ] || (echo "SYNC_TOKEN missing" && exit 1)

      - name: Call Cafe24 sync webhook (capture body)
        env:
          URL:   ${{ secrets.CAFE24_SYNC_URL }}
          TOKEN: ${{ secrets.SYNC_TOKEN }}
          MODE:  ${{ github.event.inputs.mode  || 'full' }}
          SINCE: ${{ github.event.inputs.since || '' }}
          ASYNC: ${{ github.event.inputs.async || '0' }}
        run: |
          echo "URL=$URL"
          BODY="{\"mode\":\"$MODE\",\"since\":\"$SINCE\",\"async\":\"$ASYNC\"}"
          # Authorization 헤더 + 쿼리 token 동시 사용
          curl -sS -X POST "$URL?token=$TOKEN" \
            -H "Content-Type: application/json" \
            -H "X-Api-Key: $TOKEN" \
            -H "Authorization: Bearer $TOKEN" \
            -d "$BODY" \
            -D headers.txt -o body.txt -w "\nHTTP_CODE=%{http_code}\n"
          echo "----- response headers -----"; cat headers.txt || true
          echo "----- response body -----";    cat body.txt    || true
          # 200/202만 성공 처리
          code=$(grep HTTP_CODE body.txt | sed 's/.*=//')
          echo "HTTP_CODE=$code"
          if [ "$code" = "200" ] || [ "$code" = "202" ]; then
            echo "OK"
          else
            exit 1
          fi
