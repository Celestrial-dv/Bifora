name: RAG Knowledge Base Sync (Optimized & Stable)

# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# 📌 최적화 설정 요약
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# ✅ 배치 크기: 100건 (Supabase timeout 방지)
# ✅ 워커 수: 2개 (API rate limit 준수)
# ✅ 타임아웃: 180분 (충분한 처리 시간)
# ✅ 대기 시간: 3초 (API 부하 분산)
# ✅ 증분 동기화: skip-synced=1 (중복 방지)
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

on:
  schedule:
    # 매일 오후 11시 55분(한국시간) 실행
    # 한국시간(KST) = UTC + 9시간
    # 23:55 KST = 14:55 UTC
    - cron: '55 14 * * *'
  
  # 수동 실행 옵션
  workflow_dispatch:
    inputs:
      batch_size:
        description: '배치 크기 (기본값: 100)'
        required: false
        default: '100'
      workers:
        description: '워커 수 (기본값: 2)'
        required: false
        default: '2'

env:
  WEBHOOK_URL: ${{ secrets.CAFE24_WEBHOOK_URL }}
  SYNC_TOKEN: ${{ secrets.SYNC_ACTION_TOKEN }}
  STATS_URL: ${{ secrets.CAFE24_STATS_URL }}

jobs:
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # 🔍 사전 진단 (Pre-flight Check)
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  preflight:
    name: 🔍 사전 진단
    runs-on: ubuntu-latest
    outputs:
      can_proceed: ${{ steps.check.outputs.can_proceed }}
      mysql_total: ${{ steps.stats.outputs.mysql_total }}
      supabase_synced: ${{ steps.stats.outputs.supabase_synced }}
      remaining: ${{ steps.stats.outputs.remaining }}
      
    steps:
      - name: 🔐 토큰 검증
        id: check
        run: |
          if [ -z "${{ env.SYNC_TOKEN }}" ]; then
            echo "❌ SYNC_ACTION_TOKEN이 설정되지 않았습니다."
            echo "can_proceed=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          # 서버 연결 테스트
          DIAG_URL="${{ env.WEBHOOK_URL }}&diag=1"
          
          RESPONSE=$(curl -s -w "\n%{http_code}" "$DIAG_URL")
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          if [ "$HTTP_CODE" != "200" ]; then
            echo "❌ 서버 연결 실패: HTTP $HTTP_CODE"
            echo "$BODY"
            echo "can_proceed=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          echo "✅ 토큰 검증 성공"
          echo "$BODY" | jq '.'
          echo "can_proceed=true" >> $GITHUB_OUTPUT
      
      - name: 📊 현재 통계 조회
        id: stats
        if: steps.check.outputs.can_proceed == 'true'
        run: |
          echo "📊 Supabase 통계 조회 중..."
          
          RESPONSE=$(curl -s "${{ env.STATS_URL }}")
          
          echo "응답:"
          echo "$RESPONSE" | jq '.'
          
          # JSON 파싱
          MYSQL_TOTAL=$(echo "$RESPONSE" | jq -r '.mysql_total // 0')
          SUPABASE_SYNCED=$(echo "$RESPONSE" | jq -r '.supabase_synced // 0')
          SUPABASE_CHUNKS=$(echo "$RESPONSE" | jq -r '.supabase_total_chunks // 0')
          SYNC_RATE=$(echo "$RESPONSE" | jq -r '.sync_rate // 0')
          REMAINING=$(echo "$RESPONSE" | jq -r '.remaining // 0')
          
          echo "mysql_total=$MYSQL_TOTAL" >> $GITHUB_OUTPUT
          echo "supabase_synced=$SUPABASE_SYNCED" >> $GITHUB_OUTPUT
          echo "supabase_chunks=$SUPABASE_CHUNKS" >> $GITHUB_OUTPUT
          echo "sync_rate=$SYNC_RATE" >> $GITHUB_OUTPUT
          echo "remaining=$REMAINING" >> $GITHUB_OUTPUT
          
          echo "### 📊 현재 통계" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| 항목 | 값 |" >> $GITHUB_STEP_SUMMARY
          echo "|------|---:|" >> $GITHUB_STEP_SUMMARY
          echo "| MySQL 전체 | ${MYSQL_TOTAL}건 |" >> $GITHUB_STEP_SUMMARY
          echo "| Supabase 동기화 | ${SUPABASE_SYNCED}건 |" >> $GITHUB_STEP_SUMMARY
          echo "| Supabase 전체 청크 | ${SUPABASE_CHUNKS}개 |" >> $GITHUB_STEP_SUMMARY
          echo "| **동기화율** | **${SYNC_RATE}%** |" >> $GITHUB_STEP_SUMMARY
          echo "| 남은 데이터 | ${REMAINING}건 |" >> $GITHUB_STEP_SUMMARY

  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # 🔄 병렬 동기화 (Parallel Sync)
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  sync:
    name: 🔄 워커 ${{ matrix.worker_id }}
    runs-on: ubuntu-latest
    needs: preflight
    if: needs.preflight.outputs.can_proceed == 'true' && needs.preflight.outputs.remaining > 0
    
    strategy:
      max-parallel: 2
      matrix:
        worker_id: [0, 1]
    
    outputs:
      processed_0: ${{ steps.results.outputs.processed }}
      upserted_0: ${{ steps.results.outputs.upserted }}
      
    steps:
      - name: 🚀 배치 동기화 실행
        id: sync_batches
        env:
          BATCH_SIZE: ${{ github.event.inputs.batch_size || '100' }}
          WORKER_ID: ${{ matrix.worker_id }}
        run: |
          echo "🔧 워커 설정:"
          echo "  - 워커 ID: $WORKER_ID"
          echo "  - 배치 크기: $BATCH_SIZE"
          
          # 초기 오프셋 계산
          OFFSET=$((WORKER_ID * BATCH_SIZE))
          
          TOTAL_PROCESSED=0
          TOTAL_UPSERTED=0
          BATCH_COUNT=0
          
          while true; do
            BATCH_COUNT=$((BATCH_COUNT + 1))
            
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
            echo "📦 배치 #$BATCH_COUNT (오프셋: $OFFSET)"
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
            
            # 동기화 요청
            REQUEST_URL="${{ env.WEBHOOK_URL }}&batch=${BATCH_SIZE}&offset=${OFFSET}"
            
            RESPONSE=$(curl -s -w "\n%{http_code}" "$REQUEST_URL")
            HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
            BODY=$(echo "$RESPONSE" | sed '$d')
            
            if [ "$HTTP_CODE" != "200" ]; then
              echo "⚠️ 배치 실패: HTTP $HTTP_CODE"
              echo "$BODY"
              break
            fi
            
            # JSON 파싱
            BATCH_PROCESSED=$(echo "$BODY" | jq -r '.batch.processed // 0')
            BATCH_UPSERTED=$(echo "$BODY" | jq -r '.batch.upserted // 0')
            HAS_MORE=$(echo "$BODY" | jq -r '.config.has_more // false')
            
            # 전체 통계 추출
            MYSQL_TOTAL=$(echo "$BODY" | jq -r '.overall.mysql_total // 0')
            SUPABASE_SYNCED=$(echo "$BODY" | jq -r '.overall.supabase_synced // 0')
            SUPABASE_CHUNKS=$(echo "$BODY" | jq -r '.overall.supabase_total_chunks // 0')
            SYNC_RATE=$(echo "$BODY" | jq -r '.overall.sync_rate // 0')
            REMAINING=$(echo "$BODY" | jq -r '.overall.remaining // 0')
            
            echo "  처리: ${BATCH_PROCESSED}건"
            echo "  업로드: ${BATCH_UPSERTED}건"
            echo "  전체 통계: MySQL ${MYSQL_TOTAL} | Supabase ${SUPABASE_SYNCED} (${SYNC_RATE}%)"
            
            TOTAL_PROCESSED=$((TOTAL_PROCESSED + BATCH_PROCESSED))
            TOTAL_UPSERTED=$((TOTAL_UPSERTED + BATCH_UPSERTED))
            
            # 다음 배치 계산 (워커 수만큼 건너뛰기)
            OFFSET=$((OFFSET + BATCH_SIZE * 2))
            
            # 종료 조건
            if [ "$HAS_MORE" = "false" ] || [ "$BATCH_PROCESSED" = "0" ]; then
              echo "✅ 워커 완료"
              break
            fi
            
            # Rate limit 방지
            sleep 1
          done
          
          echo "processed=$TOTAL_PROCESSED" >> $GITHUB_OUTPUT
          echo "upserted=$TOTAL_UPSERTED" >> $GITHUB_OUTPUT
          echo "batch_count=$BATCH_COUNT" >> $GITHUB_OUTPUT
      
      - name: 📊 워커 결과 저장
        id: results
        run: |
          echo "processed=${{ steps.sync_batches.outputs.processed }}" >> $GITHUB_OUTPUT
          echo "upserted=${{ steps.sync_batches.outputs.upserted }}" >> $GITHUB_OUTPUT
          
          echo "### 워커 #${{ matrix.worker_id }} 결과" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| 항목 | 값 |" >> $GITHUB_STEP_SUMMARY
          echo "|------|---:|" >> $GITHUB_STEP_SUMMARY
          echo "| 워커 ID | ${{ matrix.worker_id }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 배치 수 | ${{ steps.sync_batches.outputs.batch_count }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 처리 건수 | ${{ steps.sync_batches.outputs.processed }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 업로드 건수 | ${{ steps.sync_batches.outputs.upserted }} |" >> $GITHUB_STEP_SUMMARY

  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # 📊 최종 통계 (Final Statistics)
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  finalize:
    name: 📊 최종 통계
    runs-on: ubuntu-latest
    needs: [preflight, sync]
    if: always() && needs.preflight.outputs.can_proceed == 'true'
    
    steps:
      - name: 📊 최종 통계 조회
        id: final_stats
        run: |
          echo "📊 최종 Supabase 통계 조회 중..."
          
          RESPONSE=$(curl -s "${{ env.STATS_URL }}")
          
          echo "응답:"
          echo "$RESPONSE" | jq '.'
          
          # JSON 파싱
          MYSQL_TOTAL=$(echo "$RESPONSE" | jq -r '.mysql_total // 0')
          SUPABASE_SYNCED=$(echo "$RESPONSE" | jq -r '.supabase_synced // 0')
          SUPABASE_CHUNKS=$(echo "$RESPONSE" | jq -r '.supabase_total_chunks // 0')
          SYNC_RATE=$(echo "$RESPONSE" | jq -r '.sync_rate // 0')
          REMAINING=$(echo "$RESPONSE" | jq -r '.remaining // 0')
          
          echo "### 🌐 전체 동기화 현황" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| 항목 | 값 |" >> $GITHUB_STEP_SUMMARY
          echo "|------|---:|" >> $GITHUB_STEP_SUMMARY
          echo "| MySQL 전체 레코드 | ${MYSQL_TOTAL}건 |" >> $GITHUB_STEP_SUMMARY
          echo "| Supabase 동기화 완료 | ${SUPABASE_SYNCED}건 |" >> $GITHUB_STEP_SUMMARY
          echo "| Supabase 전체 청크 | ${SUPABASE_CHUNKS}개 |" >> $GITHUB_STEP_SUMMARY
          echo "| **동기화율** | **${SYNC_RATE}%** |" >> $GITHUB_STEP_SUMMARY
          echo "| 남은 데이터 | ${REMAINING}건 |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "$REMAINING" -eq 0 ]; then
            echo "## ✅ 동기화 완료" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "모든 데이터가 성공적으로 동기화되었습니다! 🎉" >> $GITHUB_STEP_SUMMARY
          else
            echo "## 🔄 동기화 진행 중" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "다음 스케줄에서 계속 진행됩니다." >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: 📋 실행 정보
        run: |
          echo "### 📋 실행 정보" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **워커 수**: ${{ github.event.inputs.workers || '2' }}개" >> $GITHUB_STEP_SUMMARY
          echo "- **배치 크기**: ${{ github.event.inputs.batch_size || '100' }}건" >> $GITHUB_STEP_SUMMARY
          echo "- **완료 시간**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          
