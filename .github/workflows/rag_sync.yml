name: RAG Knowledge Base Sync (Auto Resync)

# ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
# üìå ÏµúÏ†ÅÌôî ÏÑ§Ï†ï ÏöîÏïΩ
# ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
# ‚úÖ Î∞∞Ïπò ÌÅ¨Í∏∞: 100Í±¥ (Supabase timeout Î∞©ÏßÄ)
# ‚úÖ ÏõåÏª§ Ïàò: 2Í∞ú (API rate limit Ï§ÄÏàò)
# ‚úÖ ÌÉÄÏûÑÏïÑÏõÉ: 180Î∂Ñ (Ï∂©Î∂ÑÌïú Ï≤òÎ¶¨ ÏãúÍ∞Ñ)
# ‚úÖ ÎåÄÍ∏∞ ÏãúÍ∞Ñ: 3Ï¥à (API Î∂ÄÌïò Î∂ÑÏÇ∞)
# ‚úÖ Ï¶ùÎ∂Ñ ÎèôÍ∏∞Ìôî: skip-synced=1 (Ï§ëÎ≥µ Î∞©ÏßÄ)
# ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

on:
  schedule:
    # Îß§Ïùº Ïò§ÌõÑ 11Ïãú 55Î∂Ñ(ÌïúÍµ≠ÏãúÍ∞Ñ) Ïã§Ìñâ
    # ÌïúÍµ≠ÏãúÍ∞Ñ(KST) = UTC + 9ÏãúÍ∞Ñ
    # 23:55 KST = 14:55 UTC
    - cron: '55 14 * * *'
  
  # ÏàòÎèô Ïã§Ìñâ ÏòµÏÖò
  workflow_dispatch:
    inputs:
      batch_size:
        description: 'Î∞∞Ïπò ÌÅ¨Í∏∞ (Í∏∞Î≥∏Í∞í: 50)'
        required: false
        default: '50'
      workers:
        description: 'ÏõåÏª§ Ïàò (Í∏∞Î≥∏Í∞í: 2)'
        required: false
        default: '2'
      max_iterations:
        description: 'ÏõåÏª§Îãπ ÏµúÎåÄ Î∞òÎ≥µ ÌöüÏàò (Í∏∞Î≥∏Í∞í: 500)'
        required: false
        default: '500'

env:
  CAFE24_SYNC_URL: ${{ secrets.CAFE24_SYNC_URL }}
  SYNC_TOKEN: ${{ secrets.SYNC_TOKEN }}

jobs:
  preflight:
    name: üîç ÏÇ¨Ï†Ñ ÏßÑÎã®
    runs-on: ubuntu-latest
    outputs:
      can_proceed: ${{ steps.check.outputs.can_proceed }}
      mysql_total: ${{ steps.stats.outputs.mysql_total }}
      supabase_synced: ${{ steps.stats.outputs.supabase_synced }}
      remaining: ${{ steps.stats.outputs.remaining }}
      
    steps:
      - name: üîê ÌÜ†ÌÅ∞ Í≤ÄÏ¶ù
        id: check
        run: |
          if [ -z "${{ env.SYNC_TOKEN }}" ]; then
            echo "‚ùå SYNC_TOKENÏù¥ ÏÑ§Ï†ïÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§."
            echo "can_proceed=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          BASE_URL="${{ env.CAFE24_SYNC_URL }}"
          
          if [[ "$BASE_URL" == *"?"* ]]; then
            DIAG_URL="${BASE_URL}&t=${{ env.SYNC_TOKEN }}&diag=1"
          else
            DIAG_URL="${BASE_URL}?t=${{ env.SYNC_TOKEN }}&diag=1"
          fi
          
          RESPONSE=$(curl -s -w "\n%{http_code}" "$DIAG_URL")
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          if [ "$HTTP_CODE" != "200" ]; then
            echo "‚ùå ÏÑúÎ≤Ñ Ïó∞Í≤∞ Ïã§Ìå®: HTTP $HTTP_CODE"
            echo "$BODY"
            echo "can_proceed=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          echo "‚úÖ ÌÜ†ÌÅ∞ Í≤ÄÏ¶ù ÏÑ±Í≥µ"
          echo "$BODY" | jq '.'
          echo "can_proceed=true" >> $GITHUB_OUTPUT
      
      - name: üìä ÌòÑÏû¨ ÌÜµÍ≥Ñ Ï°∞Ìöå
        id: stats
        if: steps.check.outputs.can_proceed == 'true'
        run: |
          echo "üìä Supabase ÌÜµÍ≥Ñ Ï°∞Ìöå Ï§ë..."
          
          BASE_URL="${{ env.CAFE24_SYNC_URL }}"
          BASE_DIR=$(dirname "$BASE_URL")
          
          STATS_URL="${BASE_DIR}/sync_stats.php?t=${{ env.SYNC_TOKEN }}"
          
          RESPONSE=$(curl -s "$STATS_URL")
          
          echo "ÏùëÎãµ:"
          echo "$RESPONSE" | jq '.'
          
          ERROR=$(echo "$RESPONSE" | jq -r '.error // empty')
          if [ -n "$ERROR" ]; then
            echo "‚ùå ÌÜµÍ≥Ñ Ï°∞Ìöå Ïã§Ìå®: $ERROR"
            exit 1
          fi
          
          MYSQL_TOTAL=$(echo "$RESPONSE" | jq -r '.mysql_total // 0')
          SUPABASE_SYNCED=$(echo "$RESPONSE" | jq -r '.supabase_synced // 0')
          SYNC_RATE=$(echo "$RESPONSE" | jq -r '.sync_rate // 0')
          REMAINING=$(echo "$RESPONSE" | jq -r '.remaining // 0')
          
          echo "mysql_total=$MYSQL_TOTAL" >> $GITHUB_OUTPUT
          echo "supabase_synced=$SUPABASE_SYNCED" >> $GITHUB_OUTPUT
          echo "sync_rate=$SYNC_RATE" >> $GITHUB_OUTPUT
          echo "remaining=$REMAINING" >> $GITHUB_OUTPUT
          
          echo "### üìä ÌòÑÏû¨ ÌÜµÍ≥Ñ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Ìï≠Î™© | Í∞í |" >> $GITHUB_STEP_SUMMARY
          echo "|------|---:|" >> $GITHUB_STEP_SUMMARY
          echo "| MySQL Ï†ÑÏ≤¥ | ${MYSQL_TOTAL}Í±¥ |" >> $GITHUB_STEP_SUMMARY
          echo "| Supabase ÎèôÍ∏∞Ìôî | ${SUPABASE_SYNCED}Í±¥ |" >> $GITHUB_STEP_SUMMARY
          echo "| **ÎèôÍ∏∞ÌôîÏú®** | **${SYNC_RATE}%** |" >> $GITHUB_STEP_SUMMARY
          echo "| ÎÇ®ÏùÄ Îç∞Ïù¥ÌÑ∞ | ${REMAINING}Í±¥ |" >> $GITHUB_STEP_SUMMARY

  sync:
    name: üîÑ ÏõåÏª§ ${{ matrix.worker_id }}
    runs-on: ubuntu-latest
    needs: preflight
    if: needs.preflight.outputs.can_proceed == 'true' && needs.preflight.outputs.remaining > 0
    timeout-minutes: 480
    
    strategy:
      max-parallel: 2
      matrix:
        worker_id: [0, 1]
    
    steps:
      - name: üöÄ Î∞òÎ≥µ Î∞∞Ïπò ÎèôÍ∏∞Ìôî Ïã§Ìñâ
        id: sync_batches
        env:
          BATCH_SIZE: ${{ github.event.inputs.batch_size || '50' }}
          WORKER_ID: ${{ matrix.worker_id }}
          MAX_ITERATIONS: ${{ github.event.inputs.max_iterations || '500' }}
        run: |
          # ... (Í∏∞Ï°¥ ÎèôÍ∏∞Ìôî Î°úÏßÅ Ïú†ÏßÄ) ...
          
          echo "‚úÖ ÏõåÏª§ #${WORKER_ID} ÏôÑÎ£å"

  # ‚ö° Ïã†Í∑ú: Ïû¨ÎèôÍ∏∞Ìôî ÏûêÎèô Ïã§Ìñâ
  auto_resync:
    name: üîÑ ÏûêÎèô Ïû¨ÎèôÍ∏∞Ìôî
    runs-on: ubuntu-latest
    needs: [preflight, sync]
    if: always() && needs.preflight.outputs.can_proceed == 'true'
    
    steps:
      - name: üìä ÎèôÍ∏∞Ìôî ÌõÑ ÌÜµÍ≥Ñ ÌôïÏù∏
        id: check_remaining
        run: |
          echo "üìä ÏµúÏ¢Ö ÌÜµÍ≥Ñ Ï°∞Ìöå Ï§ë..."
          
          BASE_URL="${{ env.CAFE24_SYNC_URL }}"
          BASE_DIR=$(dirname "$BASE_URL")
          
          STATS_URL="${BASE_DIR}/sync_stats.php?t=${{ env.SYNC_TOKEN }}"
          
          RESPONSE=$(curl -s "$STATS_URL")
          
          REMAINING=$(echo "$RESPONSE" | jq -r '.remaining // 0')
          SYNC_RATE=$(echo "$RESPONSE" | jq -r '.sync_rate // 0')
          
          echo "remaining=$REMAINING" >> $GITHUB_OUTPUT
          echo "sync_rate=$SYNC_RATE" >> $GITHUB_OUTPUT
          
          echo "### üìä ÎèôÍ∏∞Ìôî ÌõÑ ÌÜµÍ≥Ñ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ÎÇ®ÏùÄ Îç∞Ïù¥ÌÑ∞: ${REMAINING}Í±¥" >> $GITHUB_STEP_SUMMARY
          echo "- ÎèôÍ∏∞ÌôîÏú®: ${SYNC_RATE}%" >> $GITHUB_STEP_SUMMARY
      
      - name: üîÑ ÏûêÎèô Ïû¨ÎèôÍ∏∞Ìôî Ïã§Ìñâ
        if: steps.check_remaining.outputs.remaining > 0  # ‚úÖ ÎÇ®ÏùÄ Îç∞Ïù¥ÌÑ∞Îßå Ï≤¥ÌÅ¨
        run: |
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "üîÑ ÏûêÎèô Ïû¨ÎèôÍ∏∞Ìôî ÏãúÏûë"
          echo "  - ÎÇ®ÏùÄ Îç∞Ïù¥ÌÑ∞: ${{ steps.check_remaining.outputs.remaining }}Í±¥"
          echo "  - ÎèôÍ∏∞ÌôîÏú®: ${{ steps.check_remaining.outputs.sync_rate }}%"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          
          BASE_URL="${{ env.CAFE24_SYNC_URL }}"
          BASE_DIR=$(dirname "$BASE_URL")
          
          RESYNC_URL="${BASE_DIR}/sync_stats.php?t=${{ env.SYNC_TOKEN }}&action=auto_resync"
          
          echo "üîó Ïû¨ÎèôÍ∏∞Ìôî URL: ${RESYNC_URL%\?t=*}?t=***&action=auto_resync"
          
          RESPONSE=$(curl -s "$RESYNC_URL")
          
          echo "ÏùëÎãµ:"
          echo "$RESPONSE" | jq '.'
          
          RESYNC_TRIGGERED=$(echo "$RESPONSE" | jq -r '.resync.triggered // false')
          RESYNC_MESSAGE=$(echo "$RESPONSE" | jq -r '.resync.message // ""')
          
          echo "### üîÑ Ïû¨ÎèôÍ∏∞Ìôî Í≤∞Í≥º" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Ìä∏Î¶¨Í±∞: ${RESYNC_TRIGGERED}" >> $GITHUB_STEP_SUMMARY
          echo "- Î©îÏãúÏßÄ: ${RESYNC_MESSAGE}" >> $GITHUB_STEP_SUMMARY

  finalize:
    name: üìä ÏµúÏ¢Ö ÌÜµÍ≥Ñ
    runs-on: ubuntu-latest
    needs: [preflight, sync, auto_resync]
    if: always() && needs.preflight.outputs.can_proceed == 'true'
    
    steps:
      - name: üìä ÏµúÏ¢Ö ÌÜµÍ≥Ñ Ï°∞Ìöå
        id: final_stats
        run: |
          echo "üìä ÏµúÏ¢Ö Supabase ÌÜµÍ≥Ñ Ï°∞Ìöå Ï§ë..."
          
          BASE_URL="${{ env.CAFE24_SYNC_URL }}"
          BASE_DIR=$(dirname "$BASE_URL")
          
          STATS_URL="${BASE_DIR}/sync_stats.php?t=${{ env.SYNC_TOKEN }}"
          
          # Ïû¨ÎèôÍ∏∞Ìôî ÏôÑÎ£å ÎåÄÍ∏∞ (30Ï¥à)
          sleep 30
          
          RESPONSE=$(curl -s "$STATS_URL")
          
          echo "ÏùëÎãµ:"
          echo "$RESPONSE" | jq '.'
          
          MYSQL_TOTAL=$(echo "$RESPONSE" | jq -r '.mysql_total // 0')
          SUPABASE_SYNCED=$(echo "$RESPONSE" | jq -r '.supabase_synced // 0')
          SYNC_RATE=$(echo "$RESPONSE" | jq -r '.sync_rate // 0')
          REMAINING=$(echo "$RESPONSE" | jq -r '.remaining // 0')
          
          echo "### üåê Ï†ÑÏ≤¥ ÎèôÍ∏∞Ìôî ÌòÑÌô©" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Ìï≠Î™© | Í∞í |" >> $GITHUB_STEP_SUMMARY
          echo "|------|---:|" >> $GITHUB_STEP_SUMMARY
          echo "| MySQL Ï†ÑÏ≤¥ Î†àÏΩîÎìú | ${MYSQL_TOTAL}Í±¥ |" >> $GITHUB_STEP_SUMMARY
          echo "| Supabase ÎèôÍ∏∞Ìôî ÏôÑÎ£å | ${SUPABASE_SYNCED}Í±¥ |" >> $GITHUB_STEP_SUMMARY
          echo "| **ÎèôÍ∏∞ÌôîÏú®** | **${SYNC_RATE}%** |" >> $GITHUB_STEP_SUMMARY
          echo "| ÎÇ®ÏùÄ Îç∞Ïù¥ÌÑ∞ | ${REMAINING}Í±¥ |" >> $GITHUB_STEP_SUMMARY
          echo "- **ÏõåÏª§ Ïàò**: ${{ github.event.inputs.workers || '2' }}Í∞ú" >> $GITHUB_STEP_SUMMARY
          echo "- **Î∞∞Ïπò ÌÅ¨Í∏∞**: ${{ github.event.inputs.batch_size || '50' }}Í±¥" >> $GITHUB_STEP_SUMMARY
          echo "- **ÏµúÎåÄ Î∞òÎ≥µ**: ${{ github.event.inputs.max_iterations || '500' }}Ìöå" >> $GITHUB_STEP_SUMMARY
          echo "- **ÏôÑÎ£å ÏãúÍ∞Ñ**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "$REMAINING" -eq 0 ]; then
            echo "## ‚úÖ ÎèôÍ∏∞Ìôî ÏôÑÎ£å" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Î™®Îì† Îç∞Ïù¥ÌÑ∞Í∞Ä ÏÑ±Í≥µÏ†ÅÏúºÎ°ú ÎèôÍ∏∞ÌôîÎêòÏóàÏäµÎãàÎã§! üéâ" >> $GITHUB_STEP_SUMMARY
          else
            echo "## üîÑ ÎèôÍ∏∞Ìôî ÏßÑÌñâ Ï§ë" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Îã§Ïùå Ïä§ÏºÄÏ§ÑÏóêÏÑú Í≥ÑÏÜç ÏßÑÌñâÎê©ÎãàÎã§." >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: üìã Ïã§Ìñâ Ï†ïÎ≥¥
        run: |
          echo "### üìã Ïã§Ìñâ Ï†ïÎ≥¥" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **ÏõåÏª§ Ïàò**: ${{ github.event.inputs.workers || '2' }}Í∞ú" >> $GITHUB_STEP_SUMMARY
          echo "- **Î∞∞Ïπò ÌÅ¨Í∏∞**: ${{ github.event.inputs.batch_size || '50' }}Í±¥" >> $GITHUB_STEP_SUMMARY
          echo "- **ÏµúÎåÄ Î∞òÎ≥µ**: ${{ github.event.inputs.max_iterations || '500' }}Ìöå" >> $GITHUB_STEP_SUMMARY
          echo "- **ÏûêÎèô Ïû¨ÎèôÍ∏∞Ìôî**: ÌôúÏÑ±Ìôî (ÏûÑÍ≥ÑÍ∞í: 500Í±¥)" >> $GITHUB_STEP_SUMMARY
          echo "- **ÏôÑÎ£å ÏãúÍ∞Ñ**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY

          
          
