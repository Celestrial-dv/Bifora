# ================================
# FILE: /.github/workflows/rag_sync.yml
# 목적: GitHub Actions가 정해진 시간(UTC)과 수동 실행으로 Cafe24의 동기화 웹훅을 호출
# 메뉴 경로: GitHub 저장소 → Actions → New workflow → (Skip) → "set up a workflow yourself" → 아래 내용 저장
# 비밀 값(Secrets) 필요: CAFE24_SYNC_URL, SYNC_TOKEN (아래 README 섹션 참조)
# ================================
name: RAG Sync (Cafe24 → Supabase)

on:
  schedule:
    # 매일 02:00 KST = UTC 17:00
    - cron: '0 17 * * *'
  workflow_dispatch:
    inputs:
      mode:
        description: 'full | incremental'
        required: false
        default: 'incremental'
      since:
        description: 'YYYY-MM-DD (optional)'
        required: false
        default: ''
      async:
        description: '1=background, 0=sync'
        required: false
        default: '1'

jobs:
  call-webhook:
    runs-on: ubuntu-latest
    steps:
      - name: Validate secrets
        run: |
          if [ -z "${{ secrets.CAFE24_SYNC_URL }}" ]; then
            echo "CAFE24_SYNC_URL is missing"; exit 1; fi
          if [ -z "${{ secrets.SYNC_TOKEN }}" ]; then
            echo "SYNC_TOKEN is missing"; exit 1; fi

      - name: Call Cafe24 sync webhook
        env:
          URL: ${{ secrets.CAFE24_SYNC_URL }}
          TOKEN: ${{ secrets.SYNC_TOKEN }}
          MODE: ${{ github.event.inputs.mode || 'incremental' }}
          SINCE: ${{ github.event.inputs.since || '' }}
          ASYNC: ${{ github.event.inputs.async || '1' }}
        run: |
          echo "URL=$URL"
          # JSON 수동 구성 (jq 미사용)
          PAYLOAD="{\"mode\":\"$MODE\",\"since\":\"$SINCE\",\"async\":\"$ASYNC\"}"
          echo "Payload=$PAYLOAD"
          # -f: 400/500이면 실패 처리
          curl -fSs -X POST "$URL" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $TOKEN" \
            -d "$PAYLOAD"

