name: RAG Knowledge Base Sync (Optimized & Stable)

# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# ðŸ“Œ ìµœì í™” ì„¤ì • ìš”ì•½
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# âœ… ë°°ì¹˜ í¬ê¸°: 100ê±´ (Supabase timeout ë°©ì§€)
# âœ… ì›Œì»¤ ìˆ˜: 2ê°œ (API rate limit ì¤€ìˆ˜)
# âœ… íƒ€ìž„ì•„ì›ƒ: 180ë¶„ (ì¶©ë¶„í•œ ì²˜ë¦¬ ì‹œê°„)
# âœ… ëŒ€ê¸° ì‹œê°„: 3ì´ˆ (API ë¶€í•˜ ë¶„ì‚°)
# âœ… ì¦ë¶„ ë™ê¸°í™”: skip-synced=1 (ì¤‘ë³µ ë°©ì§€)
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

on:
  schedule:
    # ë§¤ì¼ ì˜¤í›„ 11ì‹œ 55ë¶„(í•œêµ­ì‹œê°„) ì‹¤í–‰
    # í•œêµ­ì‹œê°„(KST) = UTC + 9ì‹œê°„
    # 23:55 KST = 14:55 UTC
    - cron: '55 14 * * *'
  
  # ìˆ˜ë™ ì‹¤í–‰ ì˜µì…˜
  workflow_dispatch:
    inputs:
      batch_size:
        description: 'ë°°ì¹˜ í¬ê¸° (ê¸°ë³¸ê°’: 100)'
        required: false
        default: '100'
      max_batches:
        description: 'ìµœëŒ€ ë°°ì¹˜ ìˆ˜ (ê¸°ë³¸ê°’: 1000, 0=ë¬´ì œí•œ)'
        required: false
        default: '1000'

env:
  CAFE24_SYNC_URL: ${{ secrets.CAFE24_SYNC_URL }}
  SYNC_TOKEN: ${{ secrets.SYNC_TOKEN }}

jobs:
  preflight:
    name: ðŸ” ì‚¬ì „ ì§„ë‹¨
    runs-on: ubuntu-latest
    outputs:
      can_proceed: ${{ steps.check.outputs.can_proceed }}
      mysql_total: ${{ steps.stats.outputs.mysql_total }}
      supabase_synced: ${{ steps.stats.outputs.supabase_synced }}
      remaining: ${{ steps.stats.outputs.remaining }}
      
    steps:
      - name: ðŸ” í† í° ê²€ì¦
        id: check
        run: |
          if [ -z "${{ env.SYNC_TOKEN }}" ]; then
            echo "âŒ SYNC_TOKENì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
            echo "can_proceed=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          DIAG_URL="${{ env.CAFE24_SYNC_URL }}/api/rag/sync_webhook.php?t=${{ env.SYNC_TOKEN }}&diag=1"
          
          RESPONSE=$(curl -s -w "\n%{http_code}" "$DIAG_URL")
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          if [ "$HTTP_CODE" != "200" ]; then
            echo "âŒ ì„œë²„ ì—°ê²° ì‹¤íŒ¨: HTTP $HTTP_CODE"
            echo "$BODY"
            echo "can_proceed=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          echo "âœ… í† í° ê²€ì¦ ì„±ê³µ"
          echo "$BODY" | jq '.'
          echo "can_proceed=true" >> $GITHUB_OUTPUT
      
      - name: ðŸ“Š í˜„ìž¬ í†µê³„ ì¡°íšŒ
        id: stats
        if: steps.check.outputs.can_proceed == 'true'
        run: |
          STATS_URL="${{ env.CAFE24_SYNC_URL }}/api/rag/sync_stats.php?t=${{ env.SYNC_TOKEN }}"
          RESPONSE=$(curl -s "$STATS_URL")
          
          echo "$RESPONSE" | jq '.'
          
          MYSQL_TOTAL=$(echo "$RESPONSE" | jq -r '.mysql_total // 0')
          SUPABASE_SYNCED=$(echo "$RESPONSE" | jq -r '.supabase_synced // 0')
          REMAINING=$(echo "$RESPONSE" | jq -r '.remaining // 0')
          
          echo "mysql_total=$MYSQL_TOTAL" >> $GITHUB_OUTPUT
          echo "supabase_synced=$SUPABASE_SYNCED" >> $GITHUB_OUTPUT
          echo "remaining=$REMAINING" >> $GITHUB_OUTPUT

  sync:
    name: ðŸ”„ ì „ì²´ ë™ê¸°í™”
    runs-on: ubuntu-latest
    needs: preflight
    if: needs.preflight.outputs.can_proceed == 'true' && needs.preflight.outputs.remaining > 0
    timeout-minutes: 180
    
    steps:
      - name: ðŸš€ ìˆœì°¨ ë°°ì¹˜ ë™ê¸°í™”
        env:
          BATCH_SIZE: ${{ github.event.inputs.batch_size || '100' }}
          MAX_BATCHES: ${{ github.event.inputs.max_batches || '1000' }}
        run: |
          echo "ðŸ”§ ë™ê¸°í™” ì„¤ì •:"
          echo "  - ë°°ì¹˜ í¬ê¸°: $BATCH_SIZE"
          echo "  - ìµœëŒ€ ë°°ì¹˜: $MAX_BATCHES"
          
          OFFSET=0
          TOTAL_PROCESSED=0
          TOTAL_UPSERTED=0
          BATCH_COUNT=0
          
          while true; do
            BATCH_COUNT=$((BATCH_COUNT + 1))
            
            # ìµœëŒ€ ë°°ì¹˜ ìˆ˜ ì²´í¬
            if [ "$MAX_BATCHES" != "0" ] && [ "$BATCH_COUNT" -gt "$MAX_BATCHES" ]; then
              echo "â¸ï¸ ìµœëŒ€ ë°°ì¹˜ ìˆ˜($MAX_BATCHES) ë„ë‹¬"
              break
            fi
            
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ðŸ“¦ ë°°ì¹˜ #$BATCH_COUNT (ì˜¤í”„ì…‹: $OFFSET)"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            
            REQUEST_URL="${{ env.CAFE24_SYNC_URL }}/api/rag/sync_webhook.php?t=${{ env.SYNC_TOKEN }}&batch=${BATCH_SIZE}&offset=${OFFSET}"
            
            RESPONSE=$(curl -s -w "\n%{http_code}" "$REQUEST_URL")
            HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
            BODY=$(echo "$RESPONSE" | sed '$d')
            
            if [ "$HTTP_CODE" != "200" ]; then
              echo "âš ï¸ ë°°ì¹˜ ì‹¤íŒ¨: HTTP $HTTP_CODE"
              echo "$BODY"
              break
            fi
            
            # JSON íŒŒì‹±
            BATCH_PROCESSED=$(echo "$BODY" | jq -r '.batch.processed // 0')
            BATCH_UPSERTED=$(echo "$BODY" | jq -r '.batch.upserted // 0')
            HAS_MORE=$(echo "$BODY" | jq -r '.config.has_more // false')
            
            echo "  ì²˜ë¦¬: ${BATCH_PROCESSED}ê±´"
            echo "  ì—…ë¡œë“œ: ${BATCH_UPSERTED}ê±´"
            echo "  ë” ìžˆìŒ: ${HAS_MORE}"
            
            TOTAL_PROCESSED=$((TOTAL_PROCESSED + BATCH_PROCESSED))
            TOTAL_UPSERTED=$((TOTAL_UPSERTED + BATCH_UPSERTED))
            
            # ë‹¤ìŒ ì˜¤í”„ì…‹
            OFFSET=$((OFFSET + BATCH_SIZE))
            
            # âœ… ì¢…ë£Œ ì¡°ê±´: has_moreê°€ falseì´ê±°ë‚˜ ì²˜ë¦¬ëœ ê±´ìˆ˜ê°€ 0
            if [ "$HAS_MORE" = "false" ] || [ "$BATCH_PROCESSED" = "0" ]; then
              echo "âœ… ì „ì²´ ë™ê¸°í™” ì™„ë£Œ"
              break
            fi
            
            # Rate limit ë°©ì§€
            sleep 2
          done
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ“Š ìµœì¢… ê²°ê³¼"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ì´ ë°°ì¹˜: $BATCH_COUNT"
          echo "ì´ ì²˜ë¦¬: $TOTAL_PROCESSEDê±´"
          echo "ì´ ì—…ë¡œë“œ: $TOTAL_UPSERTEDê±´"
          
          echo "### ðŸ“Š ë™ê¸°í™” ê²°ê³¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| í•­ëª© | ê°’ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|---:|" >> $GITHUB_STEP_SUMMARY
          echo "| ì´ ë°°ì¹˜ | ${BATCH_COUNT} |" >> $GITHUB_STEP_SUMMARY
          echo "| ì´ ì²˜ë¦¬ | ${TOTAL_PROCESSED}ê±´ |" >> $GITHUB_STEP_SUMMARY
          echo "| ì´ ì—…ë¡œë“œ | ${TOTAL_UPSERTED}ê±´ |" >> $GITHUB_STEP_SUMMARY

  finalize:
    name: ðŸ“Š ìµœì¢… í†µê³„
    runs-on: ubuntu-latest
    needs: [preflight, sync]
    if: always() && needs.preflight.outputs.can_proceed == 'true'
    
    steps:
      - name: ðŸ“Š ìµœì¢… í†µê³„ ì¡°íšŒ
        run: |
          STATS_URL="${{ env.CAFE24_SYNC_URL }}/api/rag/sync_stats.php?t=${{ env.SYNC_TOKEN }}"
          RESPONSE=$(curl -s "$STATS_URL")
          
          echo "$RESPONSE" | jq '.'
          
          MYSQL_TOTAL=$(echo "$RESPONSE" | jq -r '.mysql_total // 0')
          SUPABASE_SYNCED=$(echo "$RESPONSE" | jq -r '.supabase_synced // 0')
          SYNC_RATE=$(echo "$RESPONSE" | jq -r '.sync_rate // 0')
          REMAINING=$(echo "$RESPONSE" | jq -r '.remaining // 0')
          
          echo "### ðŸŒ ìµœì¢… ë™ê¸°í™” í˜„í™©" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| í•­ëª© | ê°’ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|---:|" >> $GITHUB_STEP_SUMMARY
          echo "| MySQL ì „ì²´ | ${MYSQL_TOTAL}ê±´ |" >> $GITHUB_STEP_SUMMARY
          echo "| Supabase ë™ê¸°í™” | ${SUPABASE_SYNCED}ê±´ |" >> $GITHUB_STEP_SUMMARY
          echo "| **ë™ê¸°í™”ìœ¨** | **${SYNC_RATE}%** |" >> $GITHUB_STEP_SUMMARY
          echo "| ë‚¨ì€ ë°ì´í„° | ${REMAINING}ê±´ |" >> $GITHUB_STEP_SUMMARY

          
