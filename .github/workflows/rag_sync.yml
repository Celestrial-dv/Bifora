name: RAG Knowledge Base Sync

on:
  schedule:
    # ë§¤ì¼ ì˜¤ì „ 3ì‹œ(KST ê¸°ì¤€ - UTC 18:00) ì‹¤í–‰
    - cron: '0 18 * * *'
  
  workflow_dispatch:
    inputs:
      batch_size:
        description: 'ë°°ì¹˜ í¬ê¸° (í•œ ë²ˆì— ì²˜ë¦¬í•  í–‰ ìˆ˜)'
        required: false
        default: '100'
      since:
        description: 'ë™ê¸°í™” ì‹œì‘ ë‚ ì§œ (YYYY-MM-DD)'
        required: false
        default: ''

env:
  WEBHOOK_URL: ${{ secrets.CAFE24_SYNC_URL }}
  SYNC_TOKEN: ${{ secrets.SYNC_TOKEN }}
  BATCH_SIZE: ${{ github.event.inputs.batch_size || '100' }}
  SINCE: ${{ github.event.inputs.since || '' }}
  MAX_ITERATIONS: 1000  # ìµœëŒ€ ë°˜ë³µ íšŸìˆ˜ (100 * 1000 = 100,000í–‰)
  SLEEP_SECONDS: 2      # API Rate Limit ë°©ì§€

jobs:
  sync:
    runs-on: ubuntu-latest
    timeout-minutes: 120  # 2ì‹œê°„ íƒ€ì„ì•„ì›ƒ
    
    steps:
      - name: ğŸ“‹ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ” Diagnostic Check
        id: diag
        run: |
          echo "ğŸ” í™˜ê²½ ì§„ë‹¨ ì¤‘..."
          
          DIAG_URL="${WEBHOOK_URL}/sync_webhook.php?diag=1&t=${SYNC_TOKEN}"
          
          RESPONSE=$(curl -sS -w "\n%{http_code}" "$DIAG_URL")
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          echo "HTTP Status: $HTTP_CODE"
          echo "$BODY" | jq '.' || echo "$BODY"
          
          if [ "$HTTP_CODE" != "200" ]; then
            echo "::error::ì§„ë‹¨ ì‹¤íŒ¨: HTTP $HTTP_CODE"
            exit 1
          fi
          
          # í† í° ê²€ì¦ í™•ì¸
          TOKEN_OK=$(echo "$BODY" | jq -r '.token_match // false')
          if [ "$TOKEN_OK" != "true" ]; then
            echo "::error::í† í° ë¶ˆì¼ì¹˜"
            exit 1
          fi
          
          echo "::notice::ì§„ë‹¨ ì™„ë£Œ âœ…"

      - name: ğŸ”„ Batch Sync Loop
        id: sync
        run: |
          echo "ğŸ”„ ë°°ì¹˜ ë™ê¸°í™” ì‹œì‘..."
          echo "ë°°ì¹˜ í¬ê¸°: $BATCH_SIZE"
          echo "ì‹œì‘ ë‚ ì§œ: ${SINCE:-'ì „ì²´'}"
          
          OFFSET=0
          TOTAL_PROCESSED=0
          TOTAL_UPSERTED=0
          ITERATION=0
          HAS_MORE="true"
          
          while [ "$HAS_MORE" = "true" ] && [ $ITERATION -lt $MAX_ITERATIONS ]; do
            ITERATION=$((ITERATION + 1))
            
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ“¦ ë°°ì¹˜ #${ITERATION}: offset=${OFFSET}, batch=${BATCH_SIZE}"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            
            # ë™ê¸°í™” ìš”ì²­
            SYNC_URL="${WEBHOOK_URL}/sync_webhook.php"
            PARAMS="t=${SYNC_TOKEN}&batch=${BATCH_SIZE}&offset=${OFFSET}&async=0"
            
            if [ -n "$SINCE" ]; then
              PARAMS="${PARAMS}&s=${SINCE}"
            fi
            
            FULL_URL="${SYNC_URL}?${PARAMS}"
            
            RESPONSE=$(curl -sS -w "\n%{http_code}" --max-time 300 "$FULL_URL")
            HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
            BODY=$(echo "$RESPONSE" | sed '$d')
            
            echo "HTTP Status: $HTTP_CODE"
            
            if [ "$HTTP_CODE" != "200" ]; then
              echo "::warning::ë°°ì¹˜ #${ITERATION} ì‹¤íŒ¨ (HTTP $HTTP_CODE)"
              echo "$BODY"
              
              # 3íšŒ ì—°ì† ì‹¤íŒ¨ ì‹œ ì¤‘ë‹¨
              if [ $ITERATION -ge 3 ]; then
                echo "::error::ì—°ì† ì‹¤íŒ¨ë¡œ ì¤‘ë‹¨"
                exit 1
              fi
              
              # ì¬ì‹œë„ ì „ ëŒ€ê¸°
              sleep $((SLEEP_SECONDS * 2))
              continue
            fi
            
            # JSON íŒŒì‹±
            PROCESSED=$(echo "$BODY" | jq -r '.processed // 0')
            UPSERTED=$(echo "$BODY" | jq -r '.upserted // 0')
            HAS_MORE=$(echo "$BODY" | jq -r '.has_more // false')
            
            TOTAL_PROCESSED=$((TOTAL_PROCESSED + PROCESSED))
            TOTAL_UPSERTED=$((TOTAL_UPSERTED + UPSERTED))
            
            echo "âœ… ì²˜ë¦¬: ${PROCESSED}ê±´, ì—…ë¡œë“œ: ${UPSERTED}ê±´"
            echo "ğŸ“Š ëˆ„ì : ì²˜ë¦¬=${TOTAL_PROCESSED}, ì—…ë¡œë“œ=${TOTAL_UPSERTED}"
            echo "ğŸ”„ ë‹¤ìŒ ë°°ì¹˜: $([ "$HAS_MORE" = "true" ] && echo "ìˆìŒ" || echo "ì—†ìŒ")"
            
            # ë‹¤ìŒ ì˜¤í”„ì…‹
            OFFSET=$((OFFSET + BATCH_SIZE))
            
            # ë” ì´ìƒ ë°ì´í„° ì—†ìœ¼ë©´ ì¢…ë£Œ
            if [ "$HAS_MORE" != "true" ]; then
              echo ""
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo "ğŸ‰ ë™ê¸°í™” ì™„ë£Œ!"
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo "ì´ ë°°ì¹˜ ìˆ˜: ${ITERATION}"
              echo "ì´ ì²˜ë¦¬: ${TOTAL_PROCESSED}ê±´"
              echo "ì´ ì—…ë¡œë“œ: ${TOTAL_UPSERTED}ê±´"
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              break
            fi
            
            # Rate Limit ë°©ì§€
            sleep $SLEEP_SECONDS
          done
          
          if [ $ITERATION -ge $MAX_ITERATIONS ]; then
            echo "::warning::ìµœëŒ€ ë°˜ë³µ íšŸìˆ˜(${MAX_ITERATIONS}) ë„ë‹¬"
          fi
          
          # GitHub Actions ì¶œë ¥
          echo "total_processed=$TOTAL_PROCESSED" >> $GITHUB_OUTPUT
          echo "total_upserted=$TOTAL_UPSERTED" >> $GITHUB_OUTPUT
          echo "iterations=$ITERATION" >> $GITHUB_OUTPUT

      - name: ğŸ“Š Summary
        if: always()
        run: |
          echo "## ğŸ”„ RAG ë™ê¸°í™” ê²°ê³¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| í•­ëª© | ê°’ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| ì´ ë°°ì¹˜ ìˆ˜ | ${{ steps.sync.outputs.iterations || '0' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ì´ ì²˜ë¦¬ ê±´ìˆ˜ | ${{ steps.sync.outputs.total_processed || '0' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ì´ ì—…ë¡œë“œ ê±´ìˆ˜ | ${{ steps.sync.outputs.total_upserted || '0' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ë°°ì¹˜ í¬ê¸° | ${BATCH_SIZE} |" >> $GITHUB_STEP_SUMMARY
          echo "| ì‹œì‘ ë‚ ì§œ | ${SINCE:-'ì „ì²´'} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… ì‘ì—… ì™„ë£Œ ì‹œê°„: $(date '+%Y-%m-%d %H:%M:%S %Z')" >> $GITHUB_STEP_SUMMARY

      - name: ğŸš¨ Notify on Failure
        if: failure()
        run: |
          echo "::error::RAG ë™ê¸°í™” ì‹¤íŒ¨"
          echo "::error::ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
