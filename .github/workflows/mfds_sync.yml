# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# MFDS (ì‹ì•½ì²˜) í™”ìž¥í’ˆ ì„±ë¶„ ìžë™ ë™ê¸°í™” Workflow v1.3
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# íŒŒì¼: /biplex/mfds_sync.yml
#
# ðŸ“… ìƒì„±ì¼: 2025-10-21
# ðŸ”„ ìµœì¢… ìˆ˜ì •: v1.3 (2025-10-22)
#
# âœ… v1.3 Updates (2025-10-22):
# - [ìˆ˜ì •] Webhook í˜¸ì¶œ ë°©ì‹ì„ POSTì—ì„œ GETìœ¼ë¡œ ë³€ê²½ (WAF ì°¨ë‹¨ ìš°íšŒ)
# - [ìˆ˜ì •] Secret ë³€ìˆ˜ëª…ì„ SYNC_ACTION_TOKENì—ì„œ SYNC_TOKENìœ¼ë¡œ í†µì¼
#
# âœ… v1.2 Updates (2025-10-22): Secret ë³€ê²½
# - ì‹ ê·œ Secret ì‚¬ìš©: DATA_SYNC_WEBHOOK_URL (MFDS/COSING ì „ìš©)
# - ê¸°ì¡´ CAFE24_SYNC_URLê³¼ ë¶„ë¦¬ (Supabase ì „ìš©)
# 
# âœ… v1.1 Updates (2025-10-22): ì‹¤í–‰ ì‹œê°„ ë³€ê²½ ë° ë™ì‹œ ì‹¤í–‰ ì§€ì›
# - ì‹¤í–‰ ì‹œê°„: ë§¤ì¼ 02:00 KST â†’ 22:10 KST
# - COSINGê³¼ ë™ì‹œ ì‹¤í–‰ ê°€ëŠ¥ (ë¹„ë™ê¸° ì²˜ë¦¬)
#
# ðŸ“‹ ê¸°ëŠ¥:
#   - ì‹ì•½ì²˜ í™”ìž¥í’ˆì›ë£Œ ì •ë³´ API ìžë™ ìˆ˜ì§‘
#   - ë§¤ì¼ ìƒˆë²½ 2ì‹œ(KST) ìžë™ ì‹¤í–‰ ë˜ëŠ” ìˆ˜ë™ ì‹¤í–‰
#   - data_sync_webhook.phpë¥¼ í†µí•œ ì•ˆì „í•œ ë°ì´í„° ë™ê¸°í™”
#   - api_fetch_logs í…Œì´ë¸”ì— MFDS_COSMETIC íƒ€ìž…ìœ¼ë¡œ ë¡œê·¸ ê¸°ë¡
#
# ðŸ”— ë°ì´í„° íë¦„:
#   GitHub Actions â†’ data_sync_webhook.php (type=mfds) â†’ api_fetch.php â†’ MySQL
#
# ðŸŽ¯ ëŒ€ìƒ í…Œì´ë¸”:
#   - mfds_cosmetic_ingredients (í‘œì¤€ëª…, ì˜ë¬¸ëª…, CASë²ˆí˜¸, ê¸°ì›ì •ì˜ ë“±)
#   - api_fetch_logs (ìˆ˜ì§‘ ë¡œê·¸: MFDS_COSMETIC)
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

name: MFDS Data Sync (ì‹ì•½ì²˜ í™”ìž¥í’ˆ ì„±ë¶„) v1.3

# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# ðŸ• ì‹¤í–‰ íŠ¸ë¦¬ê±° ì„¤ì •
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
on:
  schedule:
    # ë§¤ì¼ ì˜¤í›„ 10ì‹œ 10ë¶„(í•œêµ­ì‹œê°„) ì‹¤í–‰ (13:10 UTC)
    - cron: '15 13 * * *'
  
  workflow_dispatch:
    inputs:
      force_run:
        description: 'ê°•ì œ ì‹¤í–‰'
        required: true
        default: 'true'
        type: choice
        options:
          - 'false'
          - 'true'

env:
  DATA_SYNC_WEBHOOK_URL: ${{ secrets.DATA_SYNC_WEBHOOK_URL }}
  # [ìˆ˜ì •] ë‹¤ë¥¸ ì›Œí¬í”Œë¡œìš°ì™€ ì¼ê´€ì„±ì„ ìœ„í•´ SYNC_TOKENìœ¼ë¡œ ë³€ê²½
  SYNC_TOKEN: ${{ secrets.SYNC_TOKEN }}

jobs:
  preflight:
    name: ðŸ” ì‚¬ì „ ì§„ë‹¨
    runs-on: ubuntu-latest
    outputs:
      can_proceed: ${{ steps.check.outputs.can_proceed }}
      
    steps:
      - name: âš™ï¸ í™˜ê²½ ë³€ìˆ˜ í™•ì¸
        id: check
        run: |
          echo "ðŸ” í™˜ê²½ ë³€ìˆ˜ ê²€ì¦ ì¤‘..."
          if [ -z "${{ env.DATA_SYNC_WEBHOOK_URL }}" ]; then
            echo "âŒ DATA_SYNC_WEBHOOK_URLì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
            echo "can_proceed=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          if [ -z "${{ env.SYNC_TOKEN }}" ]; then
            # [ìˆ˜ì •] í™•ì¸í•˜ëŠ” Secret ë³€ìˆ˜ëª… ë³€ê²½
            echo "âŒ SYNC_TOKENì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
            echo "can_proceed=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          echo "âœ… í™˜ê²½ ë³€ìˆ˜ ê²€ì¦ ì™„ë£Œ"
          echo "can_proceed=true" >> $GITHUB_OUTPUT
      
      - name: ðŸŒ ì„œë²„ ì—°ê²° í…ŒìŠ¤íŠ¸
        run: |
          echo "ðŸŒ ì„œë²„ ì—°ê²° í™•ì¸ ì¤‘..."
          WEBHOOK_URL="${{ env.DATA_SYNC_WEBHOOK_URL }}"
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -X HEAD "$WEBHOOK_URL" || echo "000")
          
          if [ "$HTTP_CODE" == "000" ]; then
            echo "âŒ ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
            exit 1
          elif [ "$HTTP_CODE" == "404" ]; then
            echo "âš ï¸  data_sync_webhook.php íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (HTTP 404)"
            echo "ðŸ“ ì˜ˆìƒ ê²½ë¡œ: $WEBHOOK_URL"
            exit 1
          else
            echo "âœ… ì„œë²„ ì—°ê²° ì„±ê³µ (HTTP $HTTP_CODE)"
          fi
      
      - name: ðŸ“Š ì‚¬ì „ ì§„ë‹¨ ê²°ê³¼
        run: |
          echo "## ðŸ” ì‚¬ì „ ì§„ë‹¨ ê²°ê³¼" >> $GITHUB_STEP_SUMMARY
          echo "| í•­ëª© | ìƒíƒœ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| í™˜ê²½ ë³€ìˆ˜ | âœ… ì •ìƒ |" >> $GITHUB_STEP_SUMMARY
          echo "| ì„œë²„ ì—°ê²° | âœ… ì •ìƒ |" >> $GITHUB_STEP_SUMMARY
          echo "| ì‹¤í–‰ ê°€ëŠ¥ | âœ… ì˜ˆ |" >> $GITHUB_STEP_SUMMARY

  sync_mfds:
    name: ðŸš€ MFDS ë°ì´í„° ë™ê¸°í™”
    runs-on: ubuntu-latest
    needs: preflight
    if: needs.preflight.outputs.can_proceed == 'true'
    timeout-minutes: 60
    
    steps:
      - name: ðŸŽ¬ ë™ê¸°í™” ì‹œìž‘
        id: start_sync
        run: |
          echo "ðŸŽ¬ MFDS ì‹ì•½ì²˜ ë°ì´í„° ìˆ˜ì§‘ì„ ì‹œìž‘í•©ë‹ˆë‹¤..."
          echo "ðŸ“… ì‹¤í–‰ ì‹œê°: $(date '+%Y-%m-%d %H:%M:%S %Z')"
          echo "ðŸ”§ ì‹¤í–‰ ëª¨ë“œ: ${{ github.event_name }}"
          WEBHOOK_URL="${{ env.DATA_SYNC_WEBHOOK_URL }}"
          echo "WEBHOOK_URL=${WEBHOOK_URL}" >> $GITHUB_OUTPUT
      
      - name: ðŸ“¡ Webhook í˜¸ì¶œ (MFDS ë™ê¸°í™” íŠ¸ë¦¬ê±°)
        id: trigger
        run: |
          WEBHOOK_URL="${{ steps.start_sync.outputs.WEBHOOK_URL }}"
          FULL_URL="${WEBHOOK_URL}?type=mfds&source=github&token=${{ env.SYNC_TOKEN }}"
          
          echo "ðŸ“¡ Webhook í˜¸ì¶œ ì¤‘..."
          echo "ðŸ”— URL: ${WEBHOOK_URL}?type=mfds&source=github"
          
          # â­ï¸ [ìˆ˜ì • v1.3] WAF ì°¨ë‹¨ì„ í”¼í•˜ê¸° ìœ„í•´ POST ìš”ì²­ì„ GET ìš”ì²­ìœ¼ë¡œ ë³€ê²½ (-X POST ë° ë¶ˆí•„ìš”í•œ í—¤ë” ì œê±°)
          RESPONSE=$(curl -L \
            -H "User-Agent: GitHub-Actions-MFDS-Sync/1.3" \
            -w "\n%{http_code}" \
            -s \
            --max-time 300 \
            "$FULL_URL")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n 1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          echo "ðŸ“¥ ì‘ë‹µ ì½”ë“œ: $HTTP_CODE"
          echo "ðŸ“„ ì‘ë‹µ ë‚´ìš©: $BODY"
          
          echo "$BODY" > response.json
          
          if [ "$HTTP_CODE" != "200" ]; then
            echo "âŒ Webhook í˜¸ì¶œ ì‹¤íŒ¨ (HTTP $HTTP_CODE)"
            exit 1
          fi
          
          SUCCESS=$(echo "$BODY" | jq -r '.success // false')
          if [ "$SUCCESS" != "true" ]; then
            echo "âŒ ë™ê¸°í™” ì‹¤íŒ¨"
            MESSAGE=$(echo "$BODY" | jq -r '.message // "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"')
            echo "ì˜¤ë¥˜ ë©”ì‹œì§€: $MESSAGE"
            exit 1
          fi
          
          echo "âœ… Webhook í˜¸ì¶œ ì„±ê³µ"
      
      - name: â³ ë™ê¸°í™” ì§„í–‰ ëŒ€ê¸° (5ë¶„)
        run: |
          echo "â³ MFDS API ìˆ˜ì§‘ì´ ì§„í–‰ ì¤‘ìž…ë‹ˆë‹¤. 5ë¶„ ëŒ€ê¸°..."
          echo "ðŸ’¡ api_fetch.phpê°€ ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì‹¤í–‰ ì¤‘ìž…ë‹ˆë‹¤."
          sleep 300
          echo "âœ… ëŒ€ê¸° ì™„ë£Œ"
      
      - name: ðŸ“Š ë™ê¸°í™” ê²°ê³¼ í™•ì¸
        id: check_result
        run: |
          WEBHOOK_URL="${{ env.DATA_SYNC_WEBHOOK_URL }}"
          BASE_DIR=$(dirname "$WEBHOOK_URL")
          STATS_URL="${BASE_DIR}/monitor_api.php?action=statistics"
          
          echo "ðŸ“Š ë™ê¸°í™” ê²°ê³¼ ì¡°íšŒ ì¤‘..."
          STATS=$(curl -s "$STATS_URL")
          
          echo "ðŸ“„ í†µê³„ ë°ì´í„°:"
          echo "$STATS" | jq '.'
          
          MFDS_TOTAL=$(echo "$STATS" | jq -r '.data.mfds.total // 0')
          MFDS_LAST_FETCH=$(echo "$STATS" | jq -r '.data.mfds.last_fetch.date // "ì—†ìŒ"')
          MFDS_STATUS=$(echo "$STATS" | jq -r '.data.mfds.last_fetch.status // "ì•Œ ìˆ˜ ì—†ìŒ"')
          
          echo "MFDS_TOTAL=${MFDS_TOTAL}" >> $GITHUB_OUTPUT
          echo "MFDS_LAST_FETCH=${MFDS_LAST_FETCH}" >> $GITHUB_OUTPUT
          echo "MFDS_STATUS=${MFDS_STATUS}" >> $GITHUB_OUTPUT
          echo "âœ… ê²°ê³¼ í™•ì¸ ì™„ë£Œ"
      
      - name: ðŸ“‹ ìµœì¢… ê²°ê³¼ ìš”ì•½
        run: |
          echo "## ðŸŽ‰ MFDS ë™ê¸°í™” ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
          echo "| í•­ëª© | ê°’ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| ì „ì²´ ì„±ë¶„ ìˆ˜ | ${{ steps.check_result.outputs.MFDS_TOTAL }}ê°œ |" >> $GITHUB_STEP_SUMMARY
          echo "| ë§ˆì§€ë§‰ ìˆ˜ì§‘ | ${{ steps.check_result.outputs.MFDS_LAST_FETCH }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ìƒíƒœ | ${{ steps.check_result.outputs.MFDS_STATUS }} |" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.check_result.outputs.MFDS_STATUS }}" == "SUCCESS" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… **ë™ê¸°í™” ì„±ê³µ!**" >> $GITHUB_STEP_SUMMARY
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸  **ë™ê¸°í™” ìƒíƒœ í™•ì¸ í•„ìš”**" >> $GITHUB_STEP_SUMMARY
          fi

  on_failure:
    name: âŒ ì‹¤íŒ¨ ì²˜ë¦¬
    runs-on: ubuntu-latest
    needs: [preflight, sync_mfds]
    if: failure()
    
    steps:
      - name: ðŸ“§ ì‹¤íŒ¨ ì•Œë¦¼
        run: |
          echo "## âŒ MFDS ë™ê¸°í™” ì‹¤íŒ¨" >> $GITHUB_STEP_SUMMARY
          echo "ë™ê¸°í™” ìž‘ì—…ì´ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ” í™•ì¸ ì‚¬í•­" >> $GITHUB_STEP_SUMMARY
          echo "1. GitHub Secrets ì„¤ì • í™•ì¸ (DATA_SYNC_WEBHOOK_URL, SYNC_TOKEN)" >> $GITHUB_STEP_SUMMARY
          echo "2. ì›¹ ë°©í™”ë²½(WAF) ë¡œê·¸ì—ì„œ ì°¨ë‹¨ ì—¬ë¶€ í™•ì¸" >> $GITHUB_STEP_SUMMARY
          echo "3. ì„œë²„ ë¡œê·¸ í™•ì¸ (api_fetch_logs í…Œì´ë¸”)" >> $GITHUB_STEP_SUMMARY

          
