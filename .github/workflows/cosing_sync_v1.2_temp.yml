# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# COSING (EU CosIng) í™”ìž¥í’ˆ ì„±ë¶„ ìžë™ ë™ê¸°í™” Workflow v1.2-temp
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
#
# âš ï¸ TEMPORARY VERSION: Secret ì¶”ê°€ ì „ í…ŒìŠ¤íŠ¸ìš©
# ì •ì‹ ì‚¬ìš© ì‹œ v1.2ë¡œ êµì²´ í•„ìš” (Secret ì‚¬ìš©)
#
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

name: COSING Data Sync (EU CosIng ì„±ë¶„) v1.2-temp

on:
  schedule:
    - cron: '0 13 * * *'
  
  workflow_dispatch:
    inputs:
      force_run:
        description: 'ê°•ì œ ì‹¤í–‰ (true: ì „ì²´ ìž¬ìˆ˜ì§‘, false: ì¼ë°˜ ì‹¤í–‰)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

env:
  # âš ï¸ ìž„ì‹œ: Secret ëŒ€ì‹  ì§ì ‘ URL ì‚¬ìš©
  DATA_SYNC_WEBHOOK_URL: "https://biplex.mycafe24.com/biplex/data_sync_webhook.php"
  SYNC_TOKEN: ${{ secrets.SYNC_TOKEN }}

jobs:
  preflight:
    name: ðŸ” ì‚¬ì „ ì§„ë‹¨
    runs-on: ubuntu-latest
    outputs:
      can_proceed: ${{ steps.check.outputs.can_proceed }}
      
    steps:
      - name: âš™ï¸ í™˜ê²½ ë³€ìˆ˜ í™•ì¸
        id: check
        run: |
          echo "ðŸ” í™˜ê²½ ë³€ìˆ˜ ê²€ì¦ ì¤‘..."
          
          # Webhook URL í™•ì¸
          if [ -z "${{ env.DATA_SYNC_WEBHOOK_URL }}" ]; then
            echo "âŒ DATA_SYNC_WEBHOOK_URLì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
            echo "can_proceed=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          # í† í° í™•ì¸
          if [ -z "${{ env.SYNC_TOKEN }}" ]; then
            echo "âŒ SYNC_TOKENì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
            echo "can_proceed=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          echo "âœ… í™˜ê²½ ë³€ìˆ˜ ê²€ì¦ ì™„ë£Œ"
          echo "can_proceed=true" >> $GITHUB_OUTPUT
      
      - name: ðŸŒ ì„œë²„ ì—°ê²° í…ŒìŠ¤íŠ¸
        run: |
          echo "ðŸŒ ì„œë²„ ì—°ê²° í™•ì¸ ì¤‘..."
          
          # ì§ì ‘ Webhook URL ì‚¬ìš©
          WEBHOOK_URL="${{ env.DATA_SYNC_WEBHOOK_URL }}"
          
          echo "ðŸ“ í…ŒìŠ¤íŠ¸ URL: $WEBHOOK_URL"
          
          # HEAD ìš”ì²­ìœ¼ë¡œ ì„œë²„ ì—°ê²° í™•ì¸
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -X HEAD "$WEBHOOK_URL" || echo "000")
          
          if [ "$HTTP_CODE" == "000" ]; then
            echo "âŒ ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
            exit 1
          elif [ "$HTTP_CODE" == "404" ]; then
            echo "âš ï¸  data_sync_webhook.php íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (HTTP 404)"
            echo "ðŸ“ ì˜ˆìƒ ê²½ë¡œ: $WEBHOOK_URL"
            exit 1
          else
            echo "âœ… ì„œë²„ ì—°ê²° ì„±ê³µ (HTTP $HTTP_CODE)"
          fi
      
      - name: ðŸ“Š ì‚¬ì „ ì§„ë‹¨ ê²°ê³¼
        run: |
          echo "## ðŸ” ì‚¬ì „ ì§„ë‹¨ ê²°ê³¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| í•­ëª© | ìƒíƒœ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| í™˜ê²½ ë³€ìˆ˜ | âœ… ì •ìƒ |" >> $GITHUB_STEP_SUMMARY
          echo "| ì„œë²„ ì—°ê²° | âœ… ì •ìƒ |" >> $GITHUB_STEP_SUMMARY
          echo "| ì‹¤í–‰ ê°€ëŠ¥ | âœ… ì˜ˆ |" >> $GITHUB_STEP_SUMMARY

  sync_cosing:
    name: ðŸš€ COSING ë°ì´í„° ë™ê¸°í™”
    runs-on: ubuntu-latest
    needs: preflight
    if: needs.preflight.outputs.can_proceed == 'true'
    timeout-minutes: 90
    
    steps:
      - name: ðŸŽ¬ ë™ê¸°í™” ì‹œìž‘
        id: start_sync
        run: |
          echo "ðŸŽ¬ COSING EU ì„±ë¶„ ë°ì´í„° ìˆ˜ì§‘ì„ ì‹œìž‘í•©ë‹ˆë‹¤..."
          echo "ðŸ“… ì‹¤í–‰ ì‹œê°: $(date '+%Y-%m-%d %H:%M:%S %Z')"
          echo "ðŸ”§ ì‹¤í–‰ ëª¨ë“œ: ${{ github.event_name }}"
          
          # ì§ì ‘ Webhook URL ì‚¬ìš©
          WEBHOOK_URL="${{ env.DATA_SYNC_WEBHOOK_URL }}"
          
          echo "WEBHOOK_URL=${WEBHOOK_URL}" >> $GITHUB_OUTPUT
      
      - name: ðŸ“¡ Webhook í˜¸ì¶œ (COSING ë™ê¸°í™” íŠ¸ë¦¬ê±°)
        id: trigger
        run: |
          WEBHOOK_URL="${{ steps.start_sync.outputs.WEBHOOK_URL }}"
          
          # URL íŒŒë¼ë¯¸í„° êµ¬ì„±
          FULL_URL="${WEBHOOK_URL}?type=cosing&source=github&token=${{ env.SYNC_TOKEN }}"
          
          echo "ðŸ“¡ Webhook í˜¸ì¶œ ì¤‘..."
          echo "ðŸ”— URL: ${WEBHOOK_URL}?type=cosing&source=github"
          
          # POST ìš”ì²­ìœ¼ë¡œ ë™ê¸°í™” íŠ¸ë¦¬ê±°
          RESPONSE=$(curl -X POST \
            -H "Content-Type: application/json" \
            -w "\n%{http_code}" \
            -s \
            --max-time 300 \
            "$FULL_URL")
          
          # HTTP ìƒíƒœ ì½”ë“œ ì¶”ì¶œ
          HTTP_CODE=$(echo "$RESPONSE" | tail -n 1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          echo "ðŸ“¥ ì‘ë‹µ ì½”ë“œ: $HTTP_CODE"
          echo "ðŸ“„ ì‘ë‹µ ë‚´ìš©: $BODY"
          
          # ì‘ë‹µ ì €ìž¥
          echo "$BODY" > response.json
          
          # ê²°ê³¼ ê²€ì¦
          if [ "$HTTP_CODE" != "200" ]; then
            echo "âŒ Webhook í˜¸ì¶œ ì‹¤íŒ¨ (HTTP $HTTP_CODE)"
            exit 1
          fi
          
          # JSON íŒŒì‹± (success í•„ë“œ í™•ì¸)
          SUCCESS=$(echo "$BODY" | jq -r '.success // false')
          
          if [ "$SUCCESS" != "true" ]; then
            echo "âŒ ë™ê¸°í™” ì‹¤íŒ¨"
            MESSAGE=$(echo "$BODY" | jq -r '.message // "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"')
            echo "ì˜¤ë¥˜ ë©”ì‹œì§€: $MESSAGE"
            exit 1
          fi
          
          echo "âœ… Webhook í˜¸ì¶œ ì„±ê³µ"
      
      - name: â³ ë™ê¸°í™” ì§„í–‰ ëŒ€ê¸° (10ë¶„)
        run: |
          echo "â³ COSING CSV ë‹¤ìš´ë¡œë“œ ë° íŒŒì‹±ì´ ì§„í–‰ ì¤‘ìž…ë‹ˆë‹¤. 10ë¶„ ëŒ€ê¸°..."
          echo "ðŸ’¡ cosing_fetch.phpê°€ ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì‹¤í–‰ ì¤‘ìž…ë‹ˆë‹¤."
          echo "ðŸ“¦ ì•½ 7,000ê°œ ì´ìƒì˜ ì„±ë¶„ ë°ì´í„°ë¥¼ ì²˜ë¦¬í•©ë‹ˆë‹¤."
          echo "âœ… v1.1: ë‹¤ë¥¸ í¬ë¡ ìž¡ê³¼ ë™ì‹œ ì‹¤í–‰ ê°€ëŠ¥ (ë¹„ë™ê¸° ì²˜ë¦¬)"
          
          sleep 600
          
          echo "âœ… ëŒ€ê¸° ì™„ë£Œ"
      
      - name: ðŸ“Š ë™ê¸°í™” ê²°ê³¼ í™•ì¸
        id: check_result
        run: |
          # Webhook URLì—ì„œ ë² ì´ìŠ¤ ë””ë ‰í† ë¦¬ ì¶”ì¶œ
          WEBHOOK_URL="${{ env.DATA_SYNC_WEBHOOK_URL }}"
          BASE_DIR=$(dirname "$WEBHOOK_URL")
          
          # monitor_api.phpë¥¼ í†µí•´ í†µê³„ í™•ì¸
          STATS_URL="${BASE_DIR}/monitor_api.php?action=statistics"
          
          echo "ðŸ“Š ë™ê¸°í™” ê²°ê³¼ ì¡°íšŒ ì¤‘..."
          STATS=$(curl -s "$STATS_URL")
          
          echo "ðŸ“„ í†µê³„ ë°ì´í„°:"
          echo "$STATS" | jq '.'
          
          # COSING í†µê³„ ì¶”ì¶œ
          COSING_TOTAL=$(echo "$STATS" | jq -r '.data.cosing.total // 0')
          COSING_LAST_FETCH=$(echo "$STATS" | jq -r '.data.cosing.last_fetch.date // "ì—†ìŒ"')
          COSING_STATUS=$(echo "$STATS" | jq -r '.data.cosing.last_fetch.status // "ì•Œ ìˆ˜ ì—†ìŒ"')
          
          echo "COSING_TOTAL=${COSING_TOTAL}" >> $GITHUB_OUTPUT
          echo "COSING_LAST_FETCH=${COSING_LAST_FETCH}" >> $GITHUB_OUTPUT
          echo "COSING_STATUS=${COSING_STATUS}" >> $GITHUB_OUTPUT
          
          echo "âœ… ê²°ê³¼ í™•ì¸ ì™„ë£Œ"
      
      - name: ðŸ“‹ ìµœì¢… ê²°ê³¼ ìš”ì•½
        run: |
          echo "## ðŸŽ‰ COSING ë™ê¸°í™” ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š ìˆ˜ì§‘ ê²°ê³¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| í•­ëª© | ê°’ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| ì „ì²´ ì„±ë¶„ ìˆ˜ | ${{ steps.check_result.outputs.COSING_TOTAL }}ê°œ |" >> $GITHUB_STEP_SUMMARY
          echo "| ë§ˆì§€ë§‰ ìˆ˜ì§‘ | ${{ steps.check_result.outputs.COSING_LAST_FETCH }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ìƒíƒœ | ${{ steps.check_result.outputs.COSING_STATUS }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“… ì‹¤í–‰ ì •ë³´" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **ì‹¤í–‰ ì‹œê°**: $(date '+%Y-%m-%d %H:%M:%S %Z')" >> $GITHUB_STEP_SUMMARY
          echo "- **ì‹¤í–‰ ë°©ì‹**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ë°ì´í„° ì†ŒìŠ¤**: EU CosIng CSV (Archive.org)" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.check_result.outputs.COSING_STATUS }}" == "SUCCESS" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… **ë™ê¸°í™” ì„±ê³µ!**" >> $GITHUB_STEP_SUMMARY
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸  **ë™ê¸°í™” ìƒíƒœ í™•ì¸ í•„ìš”**" >> $GITHUB_STEP_SUMMARY
          fi

  on_failure:
    name: âŒ ì‹¤íŒ¨ ì²˜ë¦¬
    runs-on: ubuntu-latest
    needs: [preflight, sync_cosing]
    if: failure()
    
    steps:
      - name: ðŸ“§ ì‹¤íŒ¨ ì•Œë¦¼
        run: |
          echo "## âŒ COSING ë™ê¸°í™” ì‹¤íŒ¨" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ë™ê¸°í™” ìž‘ì—…ì´ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ” í™•ì¸ ì‚¬í•­" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. GitHub Secrets ì„¤ì • í™•ì¸ (DATA_SYNC_WEBHOOK_URL, SYNC_TOKEN)" >> $GITHUB_STEP_SUMMARY
          echo "2. data_sync_webhook.php íŒŒì¼ ì¡´ìž¬ í™•ì¸" >> $GITHUB_STEP_SUMMARY
          echo "3. CosIng CSV URL ì ‘ê·¼ ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸" >> $GITHUB_STEP_SUMMARY
          echo "4. ì„œë²„ ë¡œê·¸ í™•ì¸ (api_fetch_logs í…Œì´ë¸”)" >> $GITHUB_STEP_SUMMARY
          echo "5. ì„œë²„ ë©”ëª¨ë¦¬/íƒ€ìž„ì•„ì›ƒ ì„¤ì • í™•ì¸" >> $GITHUB_STEP_SUMMARY